var InkHost;(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{excelInkHostFactoryGlobal:()=>ee,excelInkOverlayFactoryGlobal:()=>ps});let i={logOperation(t){},logTrace(t){}};function s(t,e){i.logTrace({level:0,id:t,message:e})}class n{constructor(){this.listeners=[],this.needsSort=!1,this.needsFilter=!1}on(t,e){this.listeners.push({listener:t,options:e}),void 0!==(null==e?void 0:e.priority)&&(this.needsSort=!0),!0===(null==e?void 0:e.once)&&(this.needsFilter=!0)}off(t){const e=this.listeners.findIndex((e=>e.listener===t));-1!==e&&this.listeners.splice(e,1)}use(t,e){return this.on(t,e),()=>{this.off(t)}}emit(...t){this.needsSort&&(this.listeners.sort(((t,e)=>{var i,s,n,o;return(null!==(s=null===(i=t.options)||void 0===i?void 0:i.priority)&&void 0!==s?s:10)-(null!==(o=null===(n=e.options)||void 0===n?void 0:n.priority)&&void 0!==o?o:10)})),this.needsSort=!1);let e=!1;this.listeners.forEach((i=>{var s;e||(i.listener(...t),(null===(s=i.options)||void 0===s?void 0:s.stopPropagation)&&i.options.stopPropagation()&&(e=!0))})),this.needsFilter&&(this.listeners=this.listeners.filter((t=>{var e;return!(null===(e=t.options)||void 0===e?void 0:e.once)})),this.needsFilter=!1)}}class o{constructor(t){this.modelHostContextUpdated=new n,this.themeInfo=t}get themeInfo(){return this._themeInfo}set themeInfo(t){this._themeInfo=t,this.modelHostContextUpdated.emit([0])}}function r(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}class h{constructor(t,e){this.element=t,this.name=e}set transform(t){this.element.set(this.name,t)}setRotate(t,e=0,i=0,s=2){this.transform=a(t,e,i,s)}setScale(t,e,i=2){this.transform=u(t,e,i)}setTranslate(t,e,i=2){this.transform=c(t,e,i)}set(t,e,i,s,n=2){var o,r;0!==i||e.x||e.y?this.transform=`${c(s.x,s.y,n)}${a(i,0,0,n)}${o=e.x,r=e.y,u(o?-1:1,r?-1:1,0)}${c(t.x,t.y,n)}`:this.transform=`${c(s.x+t.x,s.y+t.y,n)}`}}function a(t,e,i,s){return 0===t?"":0!==e||0!==i?`rotate(${t.toFixed(s)},${e.toFixed(s)},${i.toFixed(s)})`:`rotate(${t.toFixed(s)})`}function u(t,e,i){return 1===t&&1===e?"":`scale(${t.toFixed(i)},${e.toFixed(i)})`}function c(t,e,i){return 0===t&&0===e?"":`translate(${t.toFixed(i)},${e.toFixed(i)})`}class l extends class{constructor(t){this.element=t}get id(){return this.element.id}set id(t){this.element.id=t}get style(){return this.element.style}set(t,e){this.element.setAttribute(t,`${e}`)}appendChild(t){this.element.appendChild(t.element)}}{constructor(t){super(t),this.transform=new h(this,"transform")}set opacity(t){this.set("opacity",t)}}class d extends l{constructor(t=r("g")){super(t)}set width(t){this.set("width",`${t}`)}set height(t){this.set("height",`${t}`)}set x(t){this.set("x",`${t}`)}set y(t){this.set("y",`${t}`)}}class p extends l{constructor(t){super(t)}set fill(t){this.set("fill",`${t}`)}set stroke(t){this.set("stroke",`${t}`)}set strokeDasharray(t){this.set("stroke-dasharray",`${t}`)}set strokeDashoffset(t){this.set("stroke-dashoffset",`${t}`)}set strokeLinecap(t){this.set("stroke-linecap",`${t}`)}set strokeLinejoin(t){this.set("stroke-linejoin",`${t}`)}set strokeMiterlimit(t){this.set("stroke-miterlimit",`${t}`)}set strokeWidth(t){this.set("stroke-width",`${t}`)}set shapeRendering(t){this.set("shape-rendering",`${t}`)}}class g extends p{constructor(t=r("polyline")){super(t)}set points(t){this.set("points",`${t}`)}clone(){return new g(this.element.cloneNode())}}function m(t,e){t.output=e}function f(t,e,i){m(t,e),m(e,i)}function y(t,e,i,s){m(t,e),f(e,i,s)}function v(t,e){return{x:t.x+e.x,y:t.y+e.y}}function w(t,e){return{x:t.x-e.x,y:t.y-e.y}}function k(t,e){return{x:t.x*e,y:t.y*e}}function x(t,e){const i=w(t,e);return function(t,e){return t.x*e.x+t.y*e.y}(i,i)}function P(t,e,i){const s=x(e,t);if(0===s)return x(i,t);const n=(i.x-e.x)*(e.y-t.y)-(e.x-t.x)*(i.y-e.y);return n*n/s}class b{constructor(t){this.threshold=t*t}beginStroke(t){this.basePoint=t,this.midPoint=t,this.output.beginStroke(t)}addPoint(t){P(this.basePoint,t,this.midPoint)>this.threshold?(this.output.addPoint(this.midPoint),this.basePoint=this.midPoint,this.midPoint=t):(x(this.basePoint,t)<x(this.basePoint,this.midPoint)&&(this.output.addPoint(this.midPoint),this.basePoint=this.midPoint),this.midPoint=t)}endStroke(t){this.addPoint(t),this.output.endStroke(t)}}class S{toCanvasImageSource(){}toSVGImageElementId(){}}const T={r:0,g:0,b:0,a:1},M={r:255,g:255,b:255,a:1},E={type:0},I={width:4,height:4,color:T,effect:E,tip:"ellipse",rasterOperation:"copy"};function A(t){return{width:t.width,height:t.height,color:t.color,effect:t.effect,tip:t.tip,rasterOperation:t.rasterOperation}}class R{constructor(t){this.attributes=A(void 0!==t?t:I)}setWidth(t){return this.attributes.width=t,this}setHeight(t){return this.attributes.height=t,this}setColor(t){return this.attributes.color=t,this}setEffect(t){return this.attributes.effect=t,this}setTip(t){return this.attributes.tip=t,this}setRasterOperation(t){return this.attributes.rasterOperation=t,this}build(){return A(this.attributes)}}class C{constructor(){this.modifier=t=>t}setDrawingAttributes(t){this.output.setDrawingAttributes(this.modifier(t))}beginStroke(t){this.output.beginStroke(t)}addPoint(t){this.output.addPoint(t)}endStroke(t){this.output.endStroke(t)}}class O{constructor(t){this.modifier=new C,this.renderer=t,m(this.modifier,this.renderer)}add(t){this.modifier.modifier=t=>new R(t).setWidth(t.width+4.5).setHeight(t.height+4.5).build(),t.stream(this.modifier),this.modifier.modifier=t=>new R(t).setColor(M).setEffect(E).build(),t.stream(this.modifier)}}class L{constructor(t){this.output=t}add(t){t.stream(this.output)}}class D{constructor(t){this.points="",this.svgPolyline=t}setDrawingAttributes(t){this.svgPolyline.setAttribute("stroke-linecap","ellipse"===t.tip?"round":"square"),this.svgPolyline.setAttribute("stroke-width",""+2*t.width)}beginStroke(t){this.addPoint(t)}addPoint(t){this.points+=`${Math.round(t.x)},${Math.round(t.y)} `}endStroke(t){this.addPoint(t),this.svgPolyline.setAttribute("points",this.points),this.points=""}}function U(t){throw t}function H(t){return document.createElement(t)}function N(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function _(){return N("path")}function F(t){for(;null!==t.lastChild;)t.removeChild(t.lastChild)}class X{constructor(){this.offsetX=0,this.offsetY=0}setDrawingAttributes(t){this.output.setDrawingAttributes(1===t.effect.type?new R(t).setEffect({type:1,pattern:t.effect.pattern,offsetX:this.offsetX,offsetY:this.offsetY}).build():t)}beginStroke(t){this.output.beginStroke(t),this.begin=t}addPoint(t){this.output.addPoint(t)}endStroke(t){this.output.endStroke(t);const e=t.x-this.begin.x,i=t.y-this.begin.y,s=e>0?48:-48;this.offsetX+=e+s,this.offsetY+=i+s,this.offsetX%=540,this.offsetY%=540}}class ${toCSSColor(t){return function(t){return`rgba(${t.r},${t.g},${t.b},${t.a})`}(t)}}function W(t,e,i=1e-6){return function(t,e=1e-6){return-e<=t&&t<=e}(t-e,i)}function Y(t){return 1.5*t+.25}class B{constructor(t,e,i){this.incomingTangent1={x:Number.NaN,y:Number.NaN},this.incomingTangent2={x:Number.NaN,y:Number.NaN},this.outgoingTangent1={x:Number.NaN,y:Number.NaN},this.outgoingTangent2={x:Number.NaN,y:Number.NaN},this.center={x:t,y:e},this.radius=i}}class V{constructor(t,e){this.stroke=[],this.builder=t,this.tipRadius=e.width/2}beginStroke(t){this.builder.beginPath(),this.stroke=[],this.addPoint(t)}addPoint(t){const e=new B(t.x,t.y,this.tipRadius*Y(t.pressure));this.stroke.push(e)}endStroke(t){this.addPoint(t),function(t){for(let e=1;e<t.length;e++){const i=t[e-1],s=t[e],n=i.center.x,o=i.center.y,r=i.radius,h=s.center.x,a=s.center.y,u=s.radius,c=n-h,l=o-a,d=Math.sqrt(c*c+l*l),p=Math.abs(u-r);if(p>d)continue;const g=1/d,m=p*g;let f=Math.sqrt(1-m*m),y=c*g,v=l*g;r>u&&(f=-f,y=-y,v=-v);const w=y*m,k=v*m,x=y*f,P=v*f,b=w+P,S=k-x,T=w-P,M=k+x;i.outgoingTangent1.x=n+r*b,i.outgoingTangent1.y=o+r*S,i.outgoingTangent2.x=n+r*T,i.outgoingTangent2.y=o+r*M,s.incomingTangent1.x=h+u*b,s.incomingTangent1.y=a+u*S,s.incomingTangent2.x=h+u*T,s.incomingTangent2.y=a+u*M}}(this.stroke),function(t,e){let i=0;for(let s=0;s<e.length;s++)(s===e.length-1||isNaN(e[s].outgoingTangent1.x))&&(z(t,e,i,s),i=s+1)}(this.builder,this.stroke),this.builder.closePath()}}function z(t,e,i,s){if(i===s){const s=e[i];return t.moveTo(s.center.x-s.radius,s.center.y),t.circularArc(s.center.x-s.radius,s.center.y,s.center.x,s.center.y,s.radius,s.center.x+s.radius,s.center.y,!1,!0),void t.circularArc(s.center.x+s.radius,s.center.y,s.center.x,s.center.y,s.radius,s.center.x-s.radius,s.center.y,!1,!0)}let n=e[i];t.moveTo(n.outgoingTangent1.x,n.outgoingTangent1.y);let o,r=n;n=e[i+1];for(let h=i+1;h<s;h++){o=e[h+1];const i=j(r.outgoingTangent1,n.incomingTangent1,n.outgoingTangent1,o.incomingTangent1);void 0!==i?t.lineTo(i.x,i.y):(t.lineTo(n.incomingTangent1.x,n.incomingTangent1.y),t.circularArc(n.incomingTangent1.x,n.incomingTangent1.y,n.center.x,n.center.y,n.radius,n.outgoingTangent1.x,n.outgoingTangent1.y,!1,!0)),r=n,n=o}const h=n.radius>e[s-1].radius;t.lineTo(n.incomingTangent1.x,n.incomingTangent1.y),t.circularArc(n.incomingTangent1.x,n.incomingTangent1.y,n.center.x,n.center.y,n.radius,n.incomingTangent2.x,n.incomingTangent2.y,h,!0),r=n,n=e[s-1];for(let h=s-1;h>i;h--){o=e[h-1];const i=j(r.incomingTangent2,n.outgoingTangent2,n.incomingTangent2,o.outgoingTangent2);void 0!==i?t.lineTo(i.x,i.y):(t.lineTo(n.outgoingTangent2.x,n.outgoingTangent2.y),t.circularArc(n.outgoingTangent2.x,n.outgoingTangent2.y,n.center.x,n.center.y,n.radius,n.incomingTangent2.x,n.incomingTangent2.y,!1,!0)),r=n,n=o}const a=n.radius>e[i+1].radius;t.lineTo(n.outgoingTangent2.x,n.outgoingTangent2.y),t.circularArc(n.outgoingTangent2.x,n.outgoingTangent2.y,n.center.x,n.center.y,n.radius,n.outgoingTangent1.x,n.outgoingTangent1.y,a,!0)}function j(t,e,i,s){if((s.x-i.x)*(e.y-t.y)-(e.x-t.x)*(s.y-i.y)>0)return;const n=e.y-t.y,o=t.x-e.x,r=n*t.x+o*t.y,h=s.y-i.y,a=i.x-s.x,u=h*i.x+a*i.y,c=n*a-h*o;if(function(t,e=1e-6){return t<-e||e<t}(c)){const l=1/c,d=(a*r-o*u)*l,p=(n*u-h*r)*l;if(q(d,p,t,e)&&q(d,p,i,s))return{x:d,y:p}}}function q(t,e,i,s){return(Math.min(i.x,s.x)<t||W(Math.min(i.x,s.x),t))&&(Math.max(i.x,s.x)>t||W(Math.max(i.x,s.x),t))&&(Math.min(i.y,s.y)<e||W(Math.min(i.y,s.y),e))&&(Math.max(i.y,s.y)>e||W(Math.max(i.y,s.y),e))}const J=2*Math.PI;function K(t,e,i){t.arc(e.x,e.y,i,0,J)}function G(t,e,i,s){const n=e.x-i,o=e.x+i,r=e.y-s,h=e.y+s;t.moveTo(n,r),t.lineTo(o,r),t.lineTo(o,h),t.lineTo(n,h),t.lineTo(n,r)}function Z(t,e){t.moveTo(e.p1.x,e.p1.y),t.lineTo(e.p2.x,e.p2.y),t.lineTo(e.p3.x,e.p3.y),t.lineTo(e.p4.x,e.p4.y),t.lineTo(e.p1.x,e.p1.y)}class Q{constructor(t,e){this.quad={p1:{x:0,y:0},p2:{x:0,y:0},p3:{x:0,y:0},p4:{x:0,y:0}},this.builder=t,this.tipRadius=e.width/2}beginStroke(t){this.builder.beginPath(),this.updateRadius(t),K(this.builder,t,this.radius),this.lastPoint=t}addPoint(t){this.updateRadius(t),function(t,e,i,s,n){const o=i.x-t.x,r=i.y-t.y,h=Math.sqrt(o*o+r*r);if(h<=Math.abs(s-e))return!1;const a=o/h,u=-r/h,c=(s-e)/h,l=Math.sqrt(1-c*c),d=u*l+a*c,p=a*l-u*c,g=u*l-a*c,m=a*l+u*c;return n.p1.x=t.x-d*e,n.p1.y=t.y-p*e,n.p2.x=i.x-d*s,n.p2.y=i.y-p*s,n.p3.x=i.x+g*s,n.p3.y=i.y+m*s,n.p4.x=t.x+g*e,n.p4.y=t.y+m*e,!0}(t,this.radius,this.lastPoint,this.lastRadius,this.quad)&&(Z(this.builder,this.quad),K(this.builder,t,this.radius)),this.lastPoint=t}endStroke(t){this.addPoint(t),this.builder.closePath()}updateRadius(t){this.lastRadius=this.radius,this.radius=this.tipRadius*Y(t.pressure)}}class tt{constructor(t){this.builder=t}beginStroke(t){this.builder.beginPath(),this.builder.moveTo(t.x,t.y)}addPoint(t){this.builder.lineTo(t.x,t.y)}endStroke(t){this.addPoint(t)}}function et(t,e,i,s,n,o,r){const h=t.x-e,a=t.y-i,u=t.x+e,c=t.y+i,l=s.x-n,d=s.y-o,p=s.x+n,g=s.y+o;if(l>=h&&d>=a&&p<=u&&g<=c||h>=l&&a>=d&&u<=p&&c<=g)return!1;const m=s.x-t.x>0?1:-1,f=s.y-t.y>0?1:-1;return r.p1.x=t.x-f*e,r.p1.y=t.y+m*i,r.p2.x=t.x+f*e,r.p2.y=t.y-m*i,r.p3.x=s.x+f*n,r.p3.y=s.y-m*o,r.p4.x=s.x-f*n,r.p4.y=s.y+m*o,!0}class it{constructor(t,e,i,s){this.center={x:t,y:e},this.halfWidth=i,this.halfHeight=s}}class st{constructor(t,e){this.stroke=[],this.quads=[],this.builder=t,this.tipWidth=e.width/2,this.tipHeight=e.height/2}beginStroke(t){this.builder.beginPath(),this.stroke=[],this.quads=[],this.addPoint(t)}addPoint(t){const e=Y(t.pressure),i=new it(t.x,t.y,this.tipWidth*e,this.tipHeight*e),s=this.stroke.length;s>0&&function(t,e,i){const s={p1:{x:0,y:0},p2:{x:0,y:0},p3:{x:0,y:0},p4:{x:0,y:0}};et(t.center,t.halfWidth,t.halfHeight,e.center,e.halfWidth,e.halfHeight,s)&&i.push(s)}(this.stroke[s-1],i,this.quads),this.stroke.push(i)}endStroke(t){this.addPoint(t),function(t,e,i){if(nt(t,e[0]),0!==i.length){t.moveTo(i[0].p1.x,i[0].p1.y);for(let e=0;e<i.length;e++)t.lineTo(i[e].p2.x,i[e].p2.y),t.lineTo(i[e].p3.x,i[e].p3.y);for(let e=i.length-1;e>=0;e--)t.lineTo(i[e].p4.x,i[e].p4.y),t.lineTo(i[e].p1.x,i[e].p1.y);e.length>2&&nt(t,e[e.length-2]),nt(t,e[e.length-1])}}(this.builder,this.stroke,this.quads),this.builder.closePath()}}function nt(t,e){G(t,e.center,e.halfWidth,e.halfHeight)}class ot{constructor(t,e){this.quad={p1:{x:0,y:0},p2:{x:0,y:0},p3:{x:0,y:0},p4:{x:0,y:0}},this.builder=t,this.tipHalfWidth=e.width/2,this.tipHalfHeight=e.height/2}beginStroke(t){this.builder.beginPath(),this.updateSize(t),G(this.builder,t,this.halfWidth,this.halfHeight),this.lastPoint=t}addPoint(t){this.updateSize(t),et(t,this.halfWidth,this.halfHeight,this.lastPoint,this.lastHalfWidth,this.lastHalfHeight,this.quad)&&(Z(this.builder,this.quad),G(this.builder,t,this.halfWidth,this.halfHeight)),this.lastPoint=t}endStroke(t){this.addPoint(t),this.builder.closePath()}updateSize(t){this.lastHalfWidth=this.halfWidth,this.lastHalfHeight=this.halfHeight;const e=Y(t.pressure);this.halfWidth=this.tipHalfWidth*e,this.halfHeight=this.tipHalfHeight*e}}function rt(t,e){-1===navigator.userAgent.indexOf("MSIE")&&-1===navigator.userAgent.indexOf("Trident")&&void 0!==window.CSS&&window.CSS.supports("mix-blend-mode","darken")&&"mask"===e.rasterOperation&&1===e.color.a&&t.setAttribute("style","mix-blend-mode: darken;")}class ht{constructor(t=1){this.path="",this.precision=t,this.format=0===t?at:t=>ut(t,this.precision)}beginPath(){this.path=""}arc(t,e,i){const s=this.format(i),n=this.format(e),o=this.format(t-i),r=this.format(t+i);this.path+=`M${o},${n}`,this.path+=`A${s},${s} 0 0,1 ${r},${n}`,this.path+=`A${s},${s} 0 0,1 ${o},${n}`}circularArc(t,e,i,s,n,o,r,h,a){this.path+=`A${this.format(n)},${this.format(n)} 0 ${h?1:0} ${a?0:1} ${this.format(o)},${this.format(r)}`}lineTo(t,e){this.path+=`L${this.format(t)},${this.format(e)}`}moveTo(t,e){this.path+=`M${this.format(t)},${this.format(e)}`}closePath(){}getPath(){return this.path}}function at(t){return`${Math.round(t)}`}function ut(t,e){return`${parseFloat(t.toFixed(e))}`}class ct{constructor(t,e,i=new $,s=1){this.renderMode=0,this.insertBeforePathElement=void 0,this.pathElement=_(),this.nextIdCounter=0,this.createPattern=t=>{const e=this.effectResolver.toSVGImageElementId(t);if(void 0===e)return;const i=this.ensureDefsElement(),s=N("pattern");s.setAttribute("id",this.nextId()),s.setAttribute("width","540"),s.setAttribute("height","540"),s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("patternUnits","userSpaceOnUse");const n=this.beginPoint.x-t.offsetX,o=this.beginPoint.y-t.offsetY;s.setAttribute("patternTransform",`scale(0.5 0.5) translate(${this.format(n)} ${this.format(o)})`);const r=N("use");return r.setAttribute("href",`#${e}`),s.append(r),i.append(s),`url(#${s.id})`},this.svgPathBuilder=new ht(s),this.svgElement=t,this.effectResolver=e,this.colorResolver=i,this.precision=s}setDrawingAttributes(t){this.attributes=t}beginStroke(t){this.pathBuilder=this.makeNewPathBuilder(),this.pathBuilder.beginStroke(t),this.pathElement=_(),this.beginPoint=t}addPoint(t){this.pathBuilder.addPoint(t)}endStroke(t){this.pathBuilder.endStroke(t),this.pathElement.setAttribute("d",this.svgPathBuilder.getPath()),void 0!==this.insertBeforePathElement?this.svgElement.insertBefore(this.pathElement,this.insertBeforePathElement):this.svgElement.appendChild(this.pathElement),2===this.renderMode?function(t,e,i){const s="ellipse"===e.tip;rt(t,e),t.setAttribute("stroke",i.toCSSColor(e.color)),t.setAttribute("stroke-width",`${e.height}`),t.setAttribute("stroke-linecap",s?"round":"butt"),t.setAttribute("stroke-linejoin",s?"round":"miter"),t.setAttribute("fill","none")}(this.pathElement,this.attributes,this.colorResolver):function(t,e,i,s){if(rt(t,e),1===e.effect.type){const i=s(e.effect);if(void 0!==i)return void t.setAttribute("fill",i)}t.setAttribute("fill",i.toCSSColor(e.color))}(this.pathElement,this.attributes,this.colorResolver,this.createPattern)}getRecentStrokePathElement(){return this.pathElement}clear(){F(this.svgElement),void 0!==this.svgDefsElement&&F(this.svgDefsElement)}makeNewPathBuilder(){switch(this.renderMode){case 0:return"ellipse"===this.attributes.tip?new Q(this.svgPathBuilder,this.attributes):new ot(this.svgPathBuilder,this.attributes);case 1:return"ellipse"===this.attributes.tip?new V(this.svgPathBuilder,this.attributes):new st(this.svgPathBuilder,this.attributes);case 2:return new tt(this.svgPathBuilder);default:U(this.renderMode)}}ensureDefsElement(){return void 0===this.svgDefsElement?(this.svgDefsElement=N("defs"),this.svgElement.appendChild(this.svgDefsElement)):null===this.svgDefsElement.parentElement&&this.svgElement.appendChild(this.svgDefsElement),this.svgDefsElement}nextId(){const t=`${this.svgElement.id}-${this.nextIdCounter}`;return this.nextIdCounter+=1,t}format(t){return ut(t,this.precision)}}function lt(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}class dt{constructor(t){this.color=lt(void 0!==t?t:T)}setRed(t){return this.color.r=t,this}setGreen(t){return this.color.g=t,this}setBlue(t){return this.color.b=t,this}setAlpha(t){return this.color.a=t,this}setHexRGB(t){return 7===t.length&&"#"===t[0]&&(this.color.r=parseInt(t.substr(1,2),16),this.color.g=parseInt(t.substr(3,2),16),this.color.b=parseInt(t.substr(5,2),16)),this}build(){return lt(this.color)}}class pt{constructor(t){this.stroke=t,this.id=t.id,this.drawingAttributes=new R(t.drawingAttributes).setColor(new dt(t.drawingAttributes.color).setAlpha(.5).build()).build(),this.modifier=new C,this.modifier.modifier=()=>this.drawingAttributes}streamChannels(t){this.stroke.streamChannels(t)}streamPoints(t){this.stroke.streamPoints(t)}streamPath(t){this.stroke.streamPath(t)}stream(t){m(this.modifier,t),this.stroke.stream(this.modifier)}}class gt{constructor(t){this.props=new Map,this.name=t,this.id=gt.opCount,gt.opCount+=1,performance.mark(this.getStartMarker())}setProp(t,e){return this.props.set(t,e.toString()),this}complete(){try{performance.mark(this.getEndMarker()),performance.measure(this.name,this.getStartMarker(),this.getEndMarker());const s=performance.getEntriesByName(this.name,"measure");s.length>0&&(t=this.name,e=s[s.length-1].duration,n=this.props.size>0?this.props:void 0,i.logOperation({name:t,durationMs:e,props:n})),performance.clearMarks(this.getStartMarker()),performance.clearMarks(this.getEndMarker()),performance.clearMeasures(this.name)}catch(t){s(0,`exception in Operation.complete: ${t.message}`)}var t,e,n}getStartMarker(){return`${this.name}.${this.id}.Start`}getEndMarker(){return`${this.name}.${this.id}.End`}}gt.opCount=0;const mt=Math.PI;function ft(t){return t*mt/180}Math.PI,Math.PI,Math.PI,Math.PI,Math.PI,Math.PI,Math.PI,Math.PI;class yt{}class vt{constructor(t){this.isSemiDry=!1,this.type=yt,this.modelUpdated=new n,this._rotation=0,this._strokes=new Map,this._bounds={top:0,left:0,bottom:0,right:0},this.hostContext=t}get rotation(){return this._rotation}get bounds(){return this._bounds}stream(t){this._strokes.forEach((e=>{e.isErased||t.add(e.stroke)}))}update(t,e,i){this._rotation=t,this._bounds=e;const s=new Map;i.stream({add:t=>{var e;const i=this._strokes.get(t.id);s.set(t.id,{stroke:t,isErased:null!==(e=null==i?void 0:i.isErased)&&void 0!==e&&e})}}),this._strokes=s,this.modelUpdated.emit()}erase(t){0!==t.length&&(t.forEach((t=>{const e=this._strokes.get(t);void 0!==e&&(e.isErased=!0)})),this.modelUpdated.emit())}remove(t){t.forEach((t=>{this._strokes.delete(t)}))}clone(){throw Error("Not implemented")}}class wt{constructor(){this.strokes=[]}add(t){this.strokes.push(t)}stream(t){this.strokes.forEach((e=>{t.add(e)}))}}class kt{constructor(){this.id=0,this.drawingAttributes=I,this.points=[]}streamChannels(t){this.points.forEach((e=>{t.addPoint(e),t.addPressure(function(t){return t.pressure}(e)),t.addTilt(e),t.addTimestamp(function(t){return t.timestamp}(e))}))}streamPoints(t){this.points.forEach((e=>{t.add(e)}))}streamPath(t){xt(this,t,0)}stream(t){Pt(this,t,0)}add(t){this.points.push(t)}}function xt(t,e,i){if(i+2>t.points.length)return i;e.beginStroke(t.points[i]);for(let s=i+1;s<t.points.length-1;s+=1)e.addPoint(t.points[s]);return e.endStroke(t.points[t.points.length-1]),t.points.length-1}function Pt(t,e,i){return e.setDrawingAttributes(1===t.drawingAttributes.effect.type&&t.points.length>0?new R(t.drawingAttributes).setEffect({type:1,pattern:t.drawingAttributes.effect.pattern,offsetX:t.drawingAttributes.effect.offsetX+t.points[i].x-t.points[0].x,offsetY:t.drawingAttributes.effect.offsetY+t.points[i].y-t.points[0].y}).build():t.drawingAttributes),xt(t,e,i)}class bt{beginStroke(t){this.output.add(t)}addPoint(t){this.output.add(t)}endStroke(t){this.output.add(t)}}class St{constructor(){this.transform=t=>t}beginStroke(t){this.output.beginStroke(this.transform(t))}addPoint(t){this.output.addPoint(this.transform(t))}endStroke(t){this.output.endStroke(this.transform(t))}}class Tt{beginStroke(t){this.firstPoint=t,this.output.beginStroke(t)}addPoint(t){this.output.addPoint(t)}endStroke(t){this.output.endStroke(t)}}function Mt(t,e){const i=new wt,s=new St;s.transform=e;const n=new bt;return t.stream({add(t){const e=new Tt,o=new kt;o.id=t.id,y(e,s,n,o),t.streamPath(e),o.drawingAttributes=1===t.drawingAttributes.effect.type?new R(t.drawingAttributes).setEffect({type:1,pattern:t.drawingAttributes.effect.pattern,offsetX:t.drawingAttributes.effect.offsetX+e.firstPoint.x-o.points[0].x,offsetY:t.drawingAttributes.effect.offsetY+e.firstPoint.y-o.points[0].y}).build():t.drawingAttributes,i.add(o)}}),i}class Et{constructor(t){this.initializer=t}get value(){return void 0===this.instance&&(this.instance=this.initializer()),this.instance}get valid(){return void 0!==this.instance}}class It{constructor(t,e){this.x=t,this.y=e}normalize(){const t=Math.sqrt(this.x*this.x+this.y*this.y);this.x=this.x/t,this.y=this.y/t}multiply(t){const e=this.x*t.m11+this.y*t.m21+t.m31,i=this.x*t.m12+this.y*t.m22+t.m32;this.x=e,this.y=i}add(t){return this.x+=t.x,this.y+=t.y,this}rotate(t,e=new It(0,0)){const i=ft(t),s=Math.cos(i),n=Math.sin(i),o=this.x-e.x,r=this.y-e.y;this.x=o*s-r*n+e.x,this.y=o*n+r*s+e.y}transform(t){const e=new It(this.x,this.y);return e.multiply(t),e}distanceTo(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}}class At{constructor(t=!1,e=!1){this.x=t,this.y=e}clone(){return new At(this.x,this.y)}equals(t){return this.x===t.x&&this.y===t.y}}class Rt{constructor(t=0,e=0){this.x=t,this.y=e}clone(){return new Rt(this.x,this.y)}equals(t){return this.x===t.x&&this.y===t.y}multiply(t){const e=this.x*t.m11+this.y*t.m21+t.m31,i=this.x*t.m12+this.y*t.m22+t.m32;return this.x=e,this.y=i,this}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}scale(t,e){return this.x*=t,this.y*=e,this}set(t){return this.x=t.x,this.y=t.y,this}}class Ct{constructor(t=0,e=0){this.width=t,this.height=e}clone(){return new Ct(this.width,this.height)}equals(t){return this.width===t.width&&this.height===t.height}subtract(t){return this.width-=t.width,this.height-=t.height,this}scale(t,e){return this.width*=t,this.height*=e,this}add(t){return this.width+=t.width,this.height+=t.height,this}}class Ot{constructor(t=new Rt,e=new Ct,i=new At,s=0){this.pos=t,this.size=e,this.flip=i,this.rot=s}clone(){return new Ot(this.pos.clone(),this.size.clone(),this.flip.clone(),this.rot)}equals(t){return this.pos.equals(t.pos)&&this.size.equals(t.size)&&this.flip.equals(t.flip)&&this.rot===t.rot}getCenter(){return new It(this.pos.x+this.size.width/2,this.pos.y+this.size.height/2)}}function Lt(t){return t.right-t.left}function Dt(t){return t.bottom-t.top}function Ut(){return{left:Number.MAX_VALUE,right:-Number.MAX_VALUE,top:Number.MAX_VALUE,bottom:-Number.MAX_VALUE}}function Ht(t,e,i){return{left:t.left-e,right:t.right+e,top:t.top-i,bottom:t.bottom+i}}function Nt(t,e){t.left=Math.min(t.left,e.left),t.top=Math.min(t.top,e.top),t.right=Math.max(t.right,e.right),t.bottom=Math.max(t.bottom,e.bottom)}function _t(t){const e=Ut();return t.streamPoints({add:t=>{!function(t,e){t.left=Math.min(t.left,e.x),t.right=Math.max(t.right,e.x),t.top=Math.min(t.top,e.y),t.bottom=Math.max(t.bottom,e.y)}(e,t)}}),e}class Ft{}class Xt{constructor(){this.type=Ft,this.pointerEventNotifiers=function(){const t=()=>new n;return{pointerdown:new Et(t),pointermove:new Et(t),pointerup:new Et(t),pointercancel:new Et(t),pointerover:new Et(t),pointerout:new Et(t)}}(),this.hitTestSlop=0,this.transform=new Ot,this.strokes=new wt,this.isSelected=!1}update(t){this.transform.size.width=Lt(t.bounds),this.transform.size.height=Dt(t.bounds),this.transform.rot=t.rotation,this.strokes=new wt,t.stream(this.strokes)}clear(){this.strokes=new wt,this.hitTestStrokes=void 0}teardown(){}ensureHitTestStrokes(){if(void 0!==this.hitTestStrokes)return this.hitTestStrokes;const t=this.hitTestStrokes=[];return(e=this.strokes,i=this.transform.size.width/2,s=this.transform.size.height/2,n=this.transform.rot,Mt(e,function(t,e,i){const s=ft(i),n=Math.cos(s),o=Math.sin(s);return i=>{const s=i.x-t,r=i.y-e;return{x:s*n-r*o+t,y:s*o+r*n+e,tiltX:i.tiltX,tiltY:i.tiltY,pressure:i.pressure,timestamp:i.timestamp}}}(i,s,n))).stream({add:e=>{t.push([_t(e),e])}}),t;var e,i,s,n}}class $t{constructor(t){this.viewModel=new Xt,this.viewModelUpdated=new n,this.onModelUpdated=()=>{this.viewModel.clear(),this.createViewModel()},this.model=t,this.model.modelUpdated.on(this.onModelUpdated),this.createViewModel()}set isSelected(t){this.viewModel.isSelected!==t&&(this.viewModel.isSelected=t,this.viewModelUpdated.emit())}teardown(){this.model.modelUpdated.off(this.onModelUpdated)}createViewModel(){this.viewModel.update(this.model),this.viewModelUpdated.emit()}}function Wt(t,e,i){const s=[-e.x,e.x,-e.y,e.y],n=[t.x-i.left,i.right-t.x,t.y-i.top,i.bottom-t.y];let o=0,r=1;for(let t=0;t<4;t+=1)if(0===s[t]){if(n[t]<0)return[10,-10]}else s[t]<0?o=Math.max(o,n[t]/s[t]):r=Math.min(r,n[t]/s[t]);return[o,r]}function Yt(t,e,i){const[s,n]=Wt(t,w(e,t),i);return s<=n}function Bt(t,e,i,s){const n=e.x-t.x,o=e.y-t.y,r=s.x-i.x,h=s.y-i.y,a=n*h-r*o;if(0===a)return!1;const u=(r*(t.y-i.y)-h*(t.x-i.x))/a,c=(n*(t.y-i.y)-o*(t.x-i.x))/a;return u>=0&&u<=1&&c>=0&&c<=1}function Vt(){}class zt extends class{constructor(t){this.onCompletion=()=>{},this.type=t}getType(){return this.type}}{constructor(t,e){super(1),this.id=t,this.strokeIds=e}getId(){return this.id}getStrokeIds(){return this.strokeIds}}class jt{constructor(t,e,i,s,n){this.id=t,this.clientBounds=e,this.strokes=i,this.hostActionHandler=s,this.model=n}getId(){return this.id}isEmpty(){return 0===this.strokes.length}erase(t,e,i){const s=t=>({x:t.x-this.clientBounds.left/i,y:t.y-this.clientBounds.top/i}),n=[];if(this.strokes.forEach((i=>{(function(t,e,[i,s]){const n=16-Lt(i),o=16-Dt(i);return n>=0&&o>=0?Yt(t,e,Ht(i,n/2,o/2)):Yt(t,e,i)&&function(t,e,i){let s,n=!1;const o={add:Vt},r=t=>{Bt(s,t,e,i)&&(o.add=Vt,n=!0),s=t};return o.add=t=>{o.add=r,s=t},t.streamPoints(o),n}(s,t,e)})(s(t),s(e),i)&&n.push(i[1].id)})),n.length>0){this.strokes=this.strokes.filter((([,t])=>-1===n.indexOf(t.id))),this.model.erase(n);const t=new zt(this.id,n);t.onCompletion=()=>{this.model.remove(n)},this.hostActionHandler.executeAction(t)}return n}}function qt(t){const e=Ut();return t.stream({add:t=>{Nt(e,_t(t))}}),e}const Jt=.5,Kt={tiltX:0,tiltY:0};class Gt{constructor(){this.id=0,this.drawingAttributes=I,this.points=[],this.pressures=[],this.tilts=[],this.timestamps=[]}streamChannels(t){this.points.forEach((e=>{t.addPoint(e)})),this.pressures.forEach((e=>{t.addPressure(e)})),this.tilts.forEach((e=>{t.addTilt(e)})),this.timestamps.forEach((e=>{t.addTimestamp(e)}))}streamPoints(t){this.points.forEach(((e,i)=>{t.add(this.getPoint(i))}))}streamPath(t){if(!(this.points.length<2)){t.beginStroke(this.getPoint(0));for(let e=1;e<this.points.length-1;e+=1)t.addPoint(this.getPoint(e));t.endStroke(this.getPoint(this.points.length-1))}}stream(t){t.setDrawingAttributes(this.drawingAttributes),this.streamPath(t)}addPoint(t){this.points.push(t)}addPressure(t){this.pressures.push(t)}addTilt(t){this.tilts.push(t)}addTimestamp(t){this.timestamps.push(t)}getPressure(t){return this.pressures.length>t?this.pressures[t]:Jt}getTilt(t){return this.tilts.length>t?this.tilts[t]:Kt}getTimestamp(t){return this.timestamps.length>t?this.timestamps[t]:0}getPoint(t){return e=this.points[t],i=this.getPressure(t),s=this.getTilt(t),n=this.getTimestamp(t),{x:e.x,y:e.y,pressure:i,tiltX:s.tiltX,tiltY:s.tiltY,timestamp:n};var e,i,s,n}}function Zt(t,e){var i;try{const s=JSON.parse(e),n={top:0,left:0,bottom:s.size.height,right:s.size.width};let o;o=void 0!==s.strokesData?function(t,e){const i=Lt(e),s=Dt(e),n=qt(t),o=Lt(n),r=Dt(n),h=0===o?0:i/o,a=0===r?0:s/r;return Mt(t,(t=>({x:e.left+(t.x-n.left)*h,y:e.top+(t.y-n.top)*a,tiltX:t.tiltX,tiltY:t.tiltY,pressure:t.pressure,timestamp:t.timestamp})))}(function(t){const e=new wt;return JSON.parse(t).forEach((t=>{e.add(function(t){return function(t){if(t.x.length!==t.y.length)throw new Error("X & Y don't match");if(0!==t.pressure.length&&t.pressure.length!==t.x.length)throw new Error("Pressure don't match X");if(t.tiltX.length!==t.tiltY.length)throw new Error("Tilt X & Y don't match");if(0!==t.tiltX.length&&t.tiltX.length!==t.x.length)throw new Error("Tilts don't match X.");if(0!==t.timestamp.length&&t.timestamp.length!==t.x.length)throw new Error("Timestamp don't match X")}(t),t.x.length===t.pressure.length&&t.x.length===t.tiltX.length&&t.x.length===t.timestamp.length?function(t){const e=new kt;return e.drawingAttributes=t.drawingAttributes,e.id=t.id,t.x.forEach(((i,s)=>{e.add({x:i,y:t.y[s],pressure:t.pressure[s],tiltX:t.tiltX[s],tiltY:t.tiltY[s],timestamp:t.timestamp[s]})})),e}(t):function(t){const e=new Gt;return e.drawingAttributes=t.drawingAttributes,e.id=t.id,t.x.forEach(((i,s)=>{e.addPoint({x:i,y:t.y[s]})})),t.pressure.forEach((t=>{e.addPressure(t)})),t.tiltX.forEach(((i,s)=>{e.addTilt({tiltX:i,tiltY:t.tiltY[s]})})),t.timestamp.forEach((t=>{e.addTimestamp(t)})),e}(t)}(t))})),e}(s.strokesData),n):new wt,t.isSemiDry=null!==(i=s.isSemiDry)&&void 0!==i&&i,t.update(s.rotation,n,o)}catch(t){s(0,`Failed to parse json object. ${t.message}`)}}class Qt{constructor(t){this.hostContext=new o,this.sqrtOfTwo=Math.sqrt(2),this.id=t.id,this.hostActionHandler=t.actionHandler,this.element=r("svg"),this.element.style.position="absolute",this.element.style.overflow="visible",this.element.setAttribute("draggable","false"),t.parent.appendChild(this.element),this.model=new vt(this.hostContext),this.presenter=new $t(this.model),this.presenter.viewModelUpdated.on((()=>{this.render()}))}isRenderTransparencySupported(){return!0}isRenderOverflowSupported(){return!0}getHitTestData(t,e,i){}updateModel(t){Zt(this.model,t)}createInkCollection(){return new jt(this.id,this.element.getBoundingClientRect(),this.model.isSemiDry?[]:this.presenter.viewModel.ensureHitTestStrokes(),this.hostActionHandler,this.model)}setSelected(t){this.presenter.isSelected=t}render(){const t=new gt("View.Render");try{this.updateAnchor();const e=this.presenter.viewModel;F(this.element),function(t,e,i,s,n,o){if(0===e.length)return[];const r=new d;r.element.id=`${performance.now()}${Math.random()}`,r.transform.set({x:-t.size.width/2,y:-t.size.height/2},t.flip,t.rot,t.getCenter()),s.appendChild(r.element);const h=new ct(r.element,new S,void 0,void 0);h.renderMode=1;const a=i?new O(h):new L(h),u=[];e.forEach((t=>{"mask"===t.drawingAttributes.rasterOperation?a.add(new pt(t)):a.add(t);const e=(new g).element,i=new D(e),s=new b(.7);m(s,i),e.style.pointerEvents="stroke",e.style.visibility="hidden",r.element.appendChild(e),u.push(e),i.setDrawingAttributes(t.drawingAttributes),t.streamPath(s)}))}(e.transform,e.strokes.strokes,e.isSelected,this.element)}finally{t.complete()}}updateAnchor(){if(0!==this.model.rotation&&this.isAnchorRotated(this.model.rotation)){const t=Math.abs(this.model.bounds.top-this.model.bounds.bottom),e=Math.abs(this.model.bounds.right-this.model.bounds.left);this.element.style.left=(t-e)/2+"px",this.element.style.top=(e-t)/2+"px"}else this.element.style.left=this.element.style.top="0px"}isAnchorRotated(t){return Math.abs(Math.sin(ft(t)))>this.sqrtOfTwo/2}}class te{constructor(t){this.logger=t}logOperation(t){this.logger.logTrace(function(t){const e={name:t.name,durationMs:t.durationMs.toString()};return void 0!==t.props&&t.props.forEach(((t,i)=>{e[i]=t})),JSON.stringify(e)}(t))}logTrace(t){this.logger.logTrace(t.message)}}const ee=new class{constructor(){this.globalLoggerSet=!1}createHost(t){return this.globalLoggerSet||(function(t){i=t}(new te(t.logger)),this.globalLoggerSet=!0),new Qt(t)}createPayload(t,e,i){return function(t,e,i){const s={rotation:0,size:{width:t,height:e},strokesData:i,isSemiDry:!0};return JSON.stringify(s)}(t,e,i)}};let ie={info:()=>{},error:()=>{}};function se(t){ie=t}let ne={logActivity(t="",e=0,i=[],s=[]){}};function oe(t){ne=t}function re(t){t.style.pointerEvents="auto"}function he(t){t.style.pointerEvents="none"}var ae,ue;function ce(t){return new HapticsPredefinedWaveform(t)}!function(t){t[t.WAVEFORM_CLICK=4099]="WAVEFORM_CLICK",t[t.WAVEFORM_BUZZ_CONTINUOUS=4100]="WAVEFORM_BUZZ_CONTINUOUS",t[t.WAVEFORM_RUMBLE_CONTINUOUS=4101]="WAVEFORM_RUMBLE_CONTINUOUS",t[t.WAVEFORM_PRESS=4102]="WAVEFORM_PRESS",t[t.WAVEFORM_RELEASE=4103]="WAVEFORM_RELEASE",t[t.WAVEFORM_HOVER=4104]="WAVEFORM_HOVER",t[t.WAVEFORM_SUCCESS=4105]="WAVEFORM_SUCCESS",t[t.WAVEFORM_ERROR=4106]="WAVEFORM_ERROR",t[t.WAVEFORM_INK_CONTINUOUS=4107]="WAVEFORM_INK_CONTINUOUS",t[t.WAVEFORM_PENCIL_CONTINUOUTS=4108]="WAVEFORM_PENCIL_CONTINUOUTS",t[t.WAVEFORM_MARKER_CONTINUOUS=4109]="WAVEFORM_MARKER_CONTINUOUS",t[t.WAVEFORM_CHISEL_MARKER_CONTINUOUS=4110]="WAVEFORM_CHISEL_MARKER_CONTINUOUS",t[t.WAVEFORM_BRUSH_CONTINUOUS=4111]="WAVEFORM_BRUSH_CONTINUOUS",t[t.WAVEFORM_ERASER_CONTINUOUS=4112]="WAVEFORM_ERASER_CONTINUOUS",t[t.WAVEFORM_FIRST_CUSTOM_VENDOR_DEFINED=10752]="WAVEFORM_FIRST_CUSTOM_VENDOR_DEFINED",t[t.WAVEFORM_SECOND_CUSTOM_VENDOR_DEFINED=8479]="WAVEFORM_SECOND_CUSTOM_VENDOR_DEFINED",t[t.WAVEFORM_GALAXY_PEN_CONTINUOUS=4113]="WAVEFORM_GALAXY_PEN_CONTINUOUS"}(ae||(ae={}));class le{constructor(){this.isPointerDown=!1}play(t){if(void 0===this.haptics)return;const e=t();void 0!==e&&this.haptics.play(e)}stop(){var t;null===(t=this.haptics)||void 0===t||t.stop()}onPointerDown(t){var e;this.isPointerDown=!0,this.extractHapticsDevice(t),null===(e=this.output)||void 0===e||e.onPointerDown(t)}onPointerMove(t){var e;this.extractHapticsDevice(t),null===(e=this.output)||void 0===e||e.onPointerMove(t)}onPointerUp(t){var e;this.isPointerDown=!1,this.extractHapticsDevice(t),null===(e=this.output)||void 0===e||e.onPointerUp(t)}extractHapticsDevice(t){var e;this.haptics=null!==(e=t.haptics)&&void 0!==e?e:void 0}}!function(t){t.Pen="pen",t.Pencil="pencil",t.Highlighter="highlighter",t.Erase="erase",t.ActionPen="actionPen",t.Laser="laser",t.Lasso="lasso",t.RemoteInk="remoteInk"}(ue||(ue={}));class de{constructor(t,e,i){this.penType="pen",this.mouseType="mouse",this.remoteInputType="unknown",this.logDataNames=["InputType","Activity","InkSec"],this.inkLogName="InkMinutes",this.cachedInkTimeInSec=0,this.cachedRemoteInkTimeInSec=0,this.cachedInkStartTime=0,this.lastInkInSec=0,this.isPointerDown=!1,this.isEventRegistered=!1,this.onPointerDown=t=>{void 0!==this.lastActivity&&(this.countDistinctSecond(t.pointerType),this.isPointerDown=!0)},this.onPointerMove=t=>{void 0!==this.lastActivity&&(void 0===this.lastInputType&&(this.lastInputType=t.pointerType),this.shouldCountPointerMove(t)&&this.countDistinctSecond(t.pointerType))},this.onPointerUp=t=>{void 0!==this.lastActivity&&(this.countDistinctSecond(t.pointerType),this.isPointerDown=!1,this.setLocalInkLogTimerHandle(this.window.setTimeout(this.logLocalInkMinute,1e3*this.logIntervalInSec)))},this.beforeUnload=()=>{this.logLocalInkMinute(),this.resetLocalInkCache(),this.logRemoteInkMinute()},this.logLocalInkMinute=()=>{if(0===this.cachedInkTimeInSec)return;if(void 0===this.lastActivity||void 0===this.lastInputType)return void(this.cachedInkTimeInSec=0);const t=[this.lastInputType,this.lastActivity,this.cachedInkTimeInSec];this.logger.logActivity(this.inkLogName,1e3*this.cachedInkTimeInSec,this.logDataNames,t),this.cachedInkTimeInSec=0},this.logRemoteInkMinute=()=>{if(0===this.cachedRemoteInkTimeInSec)return;const t=[this.remoteInputType,ue.RemoteInk,this.cachedRemoteInkTimeInSec];this.logger.logActivity(this.inkLogName,1e3*this.cachedRemoteInkTimeInSec,this.logDataNames,t),this.cachedRemoteInkTimeInSec=0},this.logger=t,this.logIntervalInSec=60*(void 0===e?1:e),this.window=null!=i?i:window}activate(t){this.isEventRegistered&&this.unregisterEvents(),this.wetCanvas=t,this.registerEvents()}deactivate(){this.isEventRegistered&&this.unregisterEvents(),this.logLocalInkMinute(),this.logRemoteInkMinute()}start(t){this.lastActivity!==t&&(void 0!==this.lastActivity&&this.end(),this.lastActivity=t)}end(){this.logLocalInkMinute(),this.resetLocalInkCache()}onRemoteWetStart(){this.countRemoteWetTime(!1)}onRemoteWetAppend(){this.countRemoteWetTime(!1)}onRemoteWetEnd(){this.countRemoteWetTime(!0)}onRemoteLaserStart(t){this.isPointerDown||1!==t&&2!==t||this.countDistinctSecond(this.remoteInputType)}onRemoteLaserMove(t){this.isPointerDown||(1!==t&&2!==t||this.countDistinctSecond(this.remoteInputType),1===t&&this.cachedRemoteInkTimeInSec>this.logIntervalInSec&&this.logRemoteInkMinute())}onRemoteLaserEnd(){this.isPointerDown||(this.countDistinctSecond(this.remoteInputType),this.setRemoteInkLogTimerHandle(this.window.setTimeout(this.logRemoteInkMinute,1e3*this.logIntervalInSec)))}setLocalInkLogTimerHandle(t){void 0!==this.localInkLogTimerHandle&&this.window.clearTimeout(this.localInkLogTimerHandle),this.localInkLogTimerHandle=t}resetLocalInkCache(){this.lastActivity=void 0,this.lastInputType=void 0}registerEvents(){this.wetCanvas.addEventListener("pointerdown",this.onPointerDown,!0),this.wetCanvas.addEventListener("pointermove",this.onPointerMove,!0),this.wetCanvas.addEventListener("pointerup",this.onPointerUp,!0),this.wetCanvas.addEventListener("beforeunload",this.beforeUnload),this.isEventRegistered=!0}unregisterEvents(){this.wetCanvas.removeEventListener("pointerdown",this.onPointerDown,!0),this.wetCanvas.removeEventListener("pointermove",this.onPointerMove,!0),this.wetCanvas.removeEventListener("pointerup",this.onPointerUp,!0),this.wetCanvas.removeEventListener("beforeunload",this.beforeUnload),this.isEventRegistered=!1}shouldCountPointerMove(t){return this.lastActivity===ue.Laser&&this.mouseType===t.pointerType&&this.mouseType===this.lastInputType||!!this.isPointerDown||this.penType===t.pointerType&&this.penType===this.lastInputType}countDistinctSecond(t){const e=Math.floor(Date.now()/1e3);if(e>this.lastInkInSec){if(t===this.remoteInputType)return this.cachedRemoteInkTimeInSec+=1,void(this.lastInkInSec=e);this.lastInputType!==t?(void 0!==this.lastInputType&&this.logLocalInkMinute(),this.lastInputType=t,this.cachedInkTimeInSec=1):this.cachedInkTimeInSec+=1,this.lastInkInSec=e,1===this.cachedInkTimeInSec&&(this.cachedInkStartTime=this.lastInkInSec),this.lastInkInSec-this.cachedInkStartTime>this.logIntervalInSec&&this.logLocalInkMinute()}}countRemoteWetTime(t){this.isPointerDown||(this.countDistinctSecond(this.remoteInputType),t&&this.setRemoteInkLogTimerHandle(this.window.setTimeout(this.logRemoteInkMinute,1e3*this.logIntervalInSec)))}setRemoteInkLogTimerHandle(t){void 0!==this.remoteInkLogTimerHandle&&this.window.clearTimeout(this.remoteInkLogTimerHandle),this.remoteInkLogTimerHandle=t}}function pe(t){return"pen"===t.pointerType}class ge{constructor(t){this.element=t}onPointerOver(t){pe(t)&&re(this.element)}onPointerOut(t){pe(t)&&he(this.element)}}class me{constructor(t){this.hapticsExtractor=new le,this.waveform=t}set output(t){m(this.hapticsExtractor,t)}onPointerDown(t){this.hapticsExtractor.onPointerDown(t),this.hapticsExtractor.play(this.waveform)}onPointerMove(t){this.hapticsExtractor.onPointerMove(t)}onPointerUp(t){this.hapticsExtractor.onPointerUp(t),this.hapticsExtractor.stop()}}class fe{constructor(t){this.onPointerOver=t=>{this.output.onPointerOver(t)},this.onPointerOut=t=>{this.output.onPointerOut(t)},this.element=t}activate(){this.element.addEventListener("pointerover",this.onPointerOver),this.element.addEventListener("pointerout",this.onPointerOut)}deactivate(){this.element.removeEventListener("pointerover",this.onPointerOver),this.element.removeEventListener("pointerout",this.onPointerOut)}}class ye{constructor(){this.active=!1}onMouseDown(t){this.output.onMouseDown(t),this.active=!0}onMouseMove(t){this.active&&this.output.onMouseMove(t)}onMouseUp(t){this.active=!1,this.output.onMouseUp(t)}}class ve{constructor(t){this.onMouseDown=t=>{this.output.onMouseDown(t)},this.onMouseMove=t=>{this.output.onMouseMove(t)},this.onMouseUp=t=>{this.output.onMouseUp(t)},this.element=t}activate(){this.element.addEventListener("mousedown",this.onMouseDown),this.element.addEventListener("mousemove",this.onMouseMove),this.element.addEventListener("mouseup",this.onMouseUp)}deactivate(){this.element.removeEventListener("mousedown",this.onMouseDown),this.element.removeEventListener("mousemove",this.onMouseMove),this.element.removeEventListener("mouseup",this.onMouseUp)}}function we(t){t.preventDefault()}function ke(t){t.preventDefault(),t.stopPropagation()}class xe{onMouseDown(t){this.output.onMouseDown(t),ke(t)}onMouseMove(t){this.output.onMouseMove(t),ke(t)}onMouseUp(t){this.output.onMouseUp(t),ke(t)}}class Pe{constructor(t){f(this.head=new ve(t),new xe,this.tail=new ye)}set output(t){this.tail.output=t}activate(){this.head.activate()}deactivate(){this.head.deactivate()}}function be(t){return{offsetX:t.offsetX,offsetY:t.offsetY,pressure:.5,tiltX:0,tiltY:0,timeStamp:t.timeStamp,pointerType:"mouse"}}class Se{onMouseDown(t){this.output.onPointerDown(be(t))}onMouseMove(t){this.output.onPointerMove(be(t))}onMouseUp(t){this.output.onPointerUp(be(t))}}class Te{constructor(t,e,i){this.normalOutput=t,this.tailOutput=e,this.barrelOutput=i,this.output=t}onPointerDown(t){pe(t)?function(t){return 5===t.button||32==(32&t.buttons)}(t)?this.output=this.tailOutput:function(t){return 2===t.button||2==(2&t.buttons)}(t)?this.output=this.barrelOutput:this.output=this.normalOutput:this.output=this.normalOutput,this.output.onPointerDown(t)}onPointerMove(t){this.output.onPointerMove(t)}onPointerUp(t){this.output.onPointerUp(t)}}class Me{constructor(){this.activePointerId=-1}onPointerDown(t){-1===this.activePointerId&&(this.activePointerId=t.pointerId,this.output.onPointerDown(t))}onPointerMove(t){this.activePointerId===t.pointerId&&this.output.onPointerMove(t)}onPointerUp(t){this.activePointerId===t.pointerId&&(this.output.onPointerUp(t),this.activePointerId=-1)}}class Ee{constructor(t){this.element=t}onPointerDown(t){try{this.element.setPointerCapture(t.pointerId)}finally{this.output.onPointerDown(t)}}onPointerMove(t){this.output.onPointerMove(t)}onPointerUp(t){this.output.onPointerUp(t)}}class Ie{onPointerDown(t){this.output.onPointerDown(t)}onPointerMove(t){(function(t){if("getCoalescedEvents"in t){const e=t.getCoalescedEvents();if(e.length>=1)return e}return[t]})(t).forEach((t=>{this.output.onPointerMove(t)}))}onPointerUp(t){this.output.onPointerUp(t)}}class Ae{constructor(t){this.onPointerDown=t=>{this.output.onPointerDown(t)},this.onPointerMove=t=>{this.output.onPointerMove(t)},this.onPointerUp=t=>{this.output.onPointerUp(t)},this.element=t}activate(){this.element.addEventListener("pointerdown",this.onPointerDown),this.element.addEventListener("pointermove",this.onPointerMove),this.element.addEventListener("pointerup",this.onPointerUp)}deactivate(){this.element.removeEventListener("pointerdown",this.onPointerDown),this.element.removeEventListener("pointermove",this.onPointerMove),this.element.removeEventListener("pointerup",this.onPointerUp)}}class Re{constructor(t){this.element=t}activate(){this.element.addEventListener("touchmove",we)}deactivate(){this.element.removeEventListener("touchmove",we)}}class Ce{onPointerDown(t){this.output.onPointerDown(t),ke(t)}onPointerMove(t){this.output.onPointerMove(t),ke(t)}onPointerUp(t){this.output.onPointerUp(t),ke(t)}}class Oe{constructor(t){var e,i,s,n,o;e=this.head=new Ae(t),i=new Ee(t),s=new Ce,n=new Me,o=this.tail=new Ie,f(e,i,s),f(s,n,o),(/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&(this.preventDefaultOnTouchMove=new Re(t))}set output(t){this.tail.output=t}activate(){var t;this.head.activate(),null===(t=this.preventDefaultOnTouchMove)||void 0===t||t.activate()}deactivate(){var t;this.head.deactivate(),null===(t=this.preventDefaultOnTouchMove)||void 0===t||t.deactivate()}}class Le{constructor(){this.activeIdentifier=-1}onTouchStart(t,e){-1===this.activeIdentifier&&(this.activeIdentifier=e.identifier,this.output.onTouchStart(t,e))}onTouchMove(t,e){this.activeIdentifier===e.identifier&&this.output.onTouchMove(t,e)}onTouchEnd(t,e){this.activeIdentifier===e.identifier&&(this.output.onTouchEnd(t,e),this.activeIdentifier=-1)}}class De{onTouchStart(t){for(let e=0;e<t.changedTouches.length;e+=1)this.output.onTouchStart(t,t.changedTouches[e])}onTouchMove(t){for(let e=0;e<t.changedTouches.length;e+=1)this.output.onTouchMove(t,t.changedTouches[e])}onTouchEnd(t){for(let e=0;e<t.changedTouches.length;e+=1)this.output.onTouchEnd(t,t.changedTouches[e])}}class Ue{constructor(t){this.onTouchStart=t=>{this.output.onTouchStart(t)},this.onTouchMove=t=>{this.output.onTouchMove(t)},this.onTouchEnd=t=>{this.output.onTouchEnd(t)},this.element=t}activate(){this.element.addEventListener("touchstart",this.onTouchStart),this.element.addEventListener("touchmove",this.onTouchMove),this.element.addEventListener("touchend",this.onTouchEnd)}deactivate(){this.element.removeEventListener("touchstart",this.onTouchStart),this.element.removeEventListener("touchmove",this.onTouchMove),this.element.removeEventListener("touchend",this.onTouchEnd)}}class He{onTouchStart(t){this.output.onTouchStart(t),ke(t)}onTouchMove(t){this.output.onTouchMove(t),ke(t)}onTouchEnd(t){this.output.onTouchEnd(t),ke(t)}}class Ne{constructor(t){y(this.head=new Ue(t),new He,new De,this.tail=new Le)}set output(t){this.tail.output=t}activate(){this.head.activate()}deactivate(){this.head.deactivate()}}function _e(t){return 180*t/Math.PI}function Fe(t,e){const i=e.target.getBoundingClientRect(),s=function(t){const e={x:0,y:0};if("azimuthAngle"in t&&"altitudeAngle"in t){const i=t.azimuthAngle,s=t.altitudeAngle;e.x=_e(Math.atan2(Math.cos(i),Math.tan(s))),e.y=_e(Math.atan2(Math.sin(i),Math.tan(s)))}return e}(e);return{offsetX:e.clientX-i.left,offsetY:e.clientY-i.top,pressure:e.force,tiltX:s.x,tiltY:s.y,timeStamp:t.timeStamp,pointerType:"touch"}}class Xe{onTouchStart(t,e){this.output.onPointerDown(Fe(t,e))}onTouchMove(t,e){this.output.onPointerMove(Fe(t,e))}onTouchEnd(t,e){this.output.onPointerUp(Fe(t,e))}}function $e(t){return{x:t.offsetX,y:t.offsetY,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timeStamp}}function We(t){return{x:t.offsetX,y:t.offsetY,pressure:Jt,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timeStamp}}class Ye{onPointerDown(t){this.output.beginStroke(We(t))}onPointerMove(t){this.output.addPoint(We(t))}onPointerUp(t){this.output.endStroke(We(t))}}function Be(t){let e=t.offsetX,i=t.offsetY;const s=t.currentTarget;if(null!==s){const n=s.getBoundingClientRect();e=t.clientX-n.left,i=t.clientY-n.top}return{x:e,y:i}}class Ve{onPointerDown(t){this.output.beginStroke(function(t){const e=Be(t);return{x:e.x,y:e.y,pressure:Jt,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timeStamp}}(t))}onPointerMove(t){this.output.addPoint(We(t))}onPointerUp(t){this.output.endStroke(We(t))}}class ze{onPointerDown(t){this.output.beginStroke($e(t))}onPointerMove(t){this.output.addPoint($e(t))}onPointerUp(t){this.output.endStroke($e(t))}}class je{onPointerDown(t){this.output.beginStroke(function(t){const e=Be(t);return{x:e.x,y:e.y,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timeStamp}}(t))}onPointerMove(t){this.output.addPoint($e(t))}onPointerUp(t){this.output.endStroke($e(t))}}class qe{beginStroke(t){this.lastPoint=t,this.output.beginStroke(t)}addPoint(t){this.lastPoint=t,this.output.addPoint(t)}endStroke(t){this.lastPoint=t,this.output.endStroke(t)}}class Je{beginStroke(t){this.output.beginStroke(t),this.point=t}addPoint(t){this.point.x===t.x&&this.point.y===t.y||(this.output.addPoint(t),this.point=t)}endStroke(t){this.output.endStroke(t)}}class Ke{beginStroke(t){this.out1={x:t.x,y:t.y},this.out2=this.out1,this.output.beginStroke(t)}addPoint(t){this.output.addPoint(this.filter(t))}endStroke(t){this.output.endStroke(this.filter(t))}filter(t){const e={x:Ge(t.x,this.out1.x,this.out2.x),y:Ge(t.y,this.out1.y,this.out2.y)};return this.out2=this.out1,this.out1=e,{x:e.x,y:e.y,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}}}function Ge(t,e,i){return.16999999999999993*t+1.33*e+-.5*i}class Ze{constructor(){this.lastPressure=Jt}beginStroke(t){this.output.beginStroke(t),this.lastPressure=t.pressure}addPoint(t){this.output.addPoint(t),this.lastPressure=t.pressure}endStroke(t){this.output.endStroke(0===t.pressure?{x:t.x,y:t.y,pressure:this.lastPressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}:t)}}class Qe{constructor(t){this.deduper=new Je,this.endStrokePressure=new Ze,this.jitter=new Ke,t?(this.preJitterLastPointExtractor=new qe,y(this.deduper,this.endStrokePressure,this.preJitterLastPointExtractor,this.jitter)):f(this.deduper,this.endStrokePressure,this.jitter)}beginStroke(t){m(this.jitter,this.output),this.deduper.beginStroke(t)}addPoint(t){this.deduper.addPoint(t)}endStroke(t){this.deduper.endStroke(t)}}function ti(t,e,i,s){const n=(t+e)/2,o=(e+i)/2,r=(i+s)/2,h=(n+o)/2,a=(o+r)/2;return[t,n,h,(h+a)/2,a,r,s]}function ei(t,e,i,s){return[(i-t)/6+e,(e-s)/6+i]}class ii{constructor(){this.began=!1}beginStroke(t){this.output.beginStroke(t),this.cp=[t,t,t,t],this.began=!0}addPoint(t){const[e,i]=this.push(t);this.began?this.began=!1:this.output.addSegment(e,i,this.cp[2])}endStroke(t){this.addPoint(t);const[e,i]=this.push(t);this.output.endStroke(e,i,this.cp[2])}push(t){return this.cp.shift(),this.cp.push(t),function(t,e,i,s){const[n,o]=ei(t.x,e.x,i.x,s.x),[r,h]=ei(t.y,e.y,i.y,s.y),[a,u]=si(e.pressure,i.pressure),[c,l]=si(e.tiltX,i.tiltX),[d,p]=si(e.tiltY,i.tiltY),[g,m]=si(e.timestamp,i.timestamp);return[{x:n,y:r,pressure:a,tiltX:c,tiltY:d,timestamp:g},{x:o,y:h,pressure:u,tiltX:l,tiltY:p,timestamp:m}]}(this.cp[0],this.cp[1],this.cp[2],this.cp[3])}}function si(t,e){const i=(e-t)/3;return[t+i,e-i]}class ni{constructor(){this.deduperJitterTransform=new Qe(!1),this.fitter=new ii,m(this.deduperJitterTransform,this.fitter)}beginStroke(t){m(this.fitter,this.output),this.deduperJitterTransform.beginStroke(t)}addPoint(t){this.deduperJitterTransform.addPoint(t)}endStroke(t){this.deduperJitterTransform.endStroke(t)}}class oi{constructor(t){this.flatness=t*t}beginStroke(t){this.output.beginStroke(t),this.beginPoint=t}addSegment(t,e,i){ri(this.beginPoint,t,e,i,this.flatness,this.output),this.output.addPoint(i),this.beginPoint=i}endStroke(t,e,i){ri(this.beginPoint,t,e,i,this.flatness,this.output),this.output.endStroke(i)}}function ri(t,e,i,s,n,o){const[r,h,a,u,c,l,d]=function(t,e,i,s){const[n,o,r,h,a,u,c]=ti(t.x,e.x,i.x,s.x),[l,d,p,g,m,f,y]=ti(t.y,e.y,i.y,s.y),[v,w,k,x,P,b,S]=ti(t.pressure,e.pressure,i.pressure,s.pressure),[T,M,E,I,A,R,C]=ti(t.tiltX,e.tiltX,i.tiltX,s.tiltX),[O,L,D,U,H,N,_]=ti(t.tiltY,e.tiltY,i.tiltY,s.tiltY),[F,X,$,W,Y,B,V]=ti(t.timestamp,e.timestamp,i.timestamp,s.timestamp);return[{x:n,y:l,pressure:v,tiltX:T,tiltY:O,timestamp:F},{x:o,y:d,pressure:w,tiltX:M,tiltY:L,timestamp:X},{x:r,y:p,pressure:k,tiltX:E,tiltY:D,timestamp:$},{x:h,y:g,pressure:x,tiltX:I,tiltY:U,timestamp:W},{x:a,y:m,pressure:P,tiltX:A,tiltY:H,timestamp:Y},{x:u,y:f,pressure:b,tiltX:R,tiltY:N,timestamp:B},{x:c,y,pressure:S,tiltX:C,tiltY:_,timestamp:V}]}(t,e,i,s);P(r,d,u)<=n||(ri(r,h,a,u,n,o),o.addPoint(u),ri(u,c,l,d,n,o))}class hi{constructor(t){this.bezierStrokePath=new ni,this.flattener=new oi(t),m(this.bezierStrokePath,this.flattener)}beginStroke(t){m(this.flattener,this.output),this.bezierStrokePath.beginStroke(t)}addPoint(t){this.bezierStrokePath.addPoint(t)}endStroke(t){this.bezierStrokePath.endStroke(t)}}class ai{constructor(t){this.pointerToStroke=function(t=!1){return-1===navigator.userAgent.indexOf("Firefox")?t?new je:new ze:t?new Ve:new Ye}(),this.strokeSmoothener=new hi(t),m(this.pointerToStroke,this.strokeSmoothener)}onPointerDown(t){m(this.strokeSmoothener,this.output),this.pointerToStroke.onPointerDown(t)}onPointerMove(t){this.pointerToStroke.onPointerMove(t)}onPointerUp(t){this.pointerToStroke.onPointerUp(t)}}class ui{constructor(t=I){this.offset=new X,this.setDrawingAttributes(t)}setDrawingAttributes(t){this.attributes=t}getDrawingAttributes(){return this.attributes}beginStroke(t){m(this.offset,this.output),this.out=1===this.attributes.effect.type?this.offset:this.output,this.out.setDrawingAttributes(this.attributes),this.out.beginStroke(t)}addPoint(t){this.out.addPoint(t)}endStroke(t){this.out.endStroke(t)}}class ci{constructor(t){this.cachedInk=[],this.hapticsExtractor=new le,this.playHapticsInterval=0,this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!1,this.store=t}onPointerDown(t){this.hapticsExtractor.onPointerDown(t),this.store.flush(),this.previousPoint={x:t.clientX/this.store.zoom,y:t.clientY/this.store.zoom},this.cachedInk=this.store.getDryStore().getInk(),this.erase(this.previousPoint,this.previousPoint)}onPointerMove(t){this.hapticsExtractor.onPointerMove(t);const e={x:t.clientX/this.store.zoom,y:t.clientY/this.store.zoom};this.erase(this.previousPoint,e),this.previousPoint=e}onPointerUp(t){this.hapticsExtractor.onPointerUp(t),this.clearHaptics(),this.cachedInk=[],this.store.getDryStore().flush()}erase(t,e){let i=!1;this.cachedInk.forEach((s=>{const n=function(t,e,i){const s=w(e,t),[n,o]=Wt(t,s,i);if(!(n>o))return{from:v(t,k(s,n)),to:v(t,k(s,o))}}(t,e,s.clipRect);if(void 0!==n)for(let t=s.collections.length-1;t>=0;t-=1){const e=s.collections[t],o=e.erase(n.from,n.to,this.store.isStandardZoomCss?this.store.zoom:1);e.isEmpty()&&s.collections.splice(t,1),i=i||0!==o.length}})),i&&this.ensurePlayStrokeHitHaptics()}ensurePlayStrokeHitHaptics(){this.needPlayStrokeHitHaptics=!0,0===this.playHapticsInterval&&(this.playHapticsInterval=window.setInterval((()=>this.playStrokeEraserHaptics()),50))}clearHaptics(){0!==this.playHapticsInterval&&(this.hapticsExtractor.stop(),window.clearInterval(this.playHapticsInterval),this.playHapticsInterval=0,this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!1)}playStrokeEraserHaptics(){var t;this.needPlayStrokeHitHaptics?(this.hapticsExtractor.play((()=>ce({waveformId:ae.WAVEFORM_CLICK,intensity:this.hapticsExtractor.isPointerDown?1:.75,vendorId:"",alternates:[]}))),this.needPlayStrokeHitHaptics=!1,this.needRestartContinuousHaptics=!0):this.needRestartContinuousHaptics&&(null===(t=this.hapticsExtractor)||void 0===t||t.play((()=>ce({waveformId:ae.WAVEFORM_ERASER_CONTINUOUS,intensity:1,vendorId:"",alternates:[]}))),this.needRestartContinuousHaptics=!1)}}class li{constructor(t,e,i,s){if(this.store=i,this.drawingHaptics=s,this.eraser=new ci(i),f(this.collector=new ai(.5),this.injector=new ui,this.store.collector),m(this.pointerOverOut=new fe(e),new ge(t)),this.outputSwitcher=new Te(this.collector,this.eraser,this.collector),void 0!==window.PointerEvent)this.continuousHaptics=new me((()=>{let t;if(this.outputSwitcher.output===this.collector)t=this.drawingHaptics();else{if(this.outputSwitcher.output!==this.eraser)return;t=ae.WAVEFORM_ERASER_CONTINUOUS}return ce({waveformId:t,intensity:1,vendorId:"",alternates:[]})})),y(this.input=new Oe(t),this.continuousHaptics,{output:this.outputSwitcher,onPointerDown:e=>{try{t.setPointerCapture(e.pointerId)}catch(t){}this.store.onPointerDown(pe(e)),this.outputSwitcher.onPointerDown(e)},onPointerMove:t=>{this.outputSwitcher.onPointerMove(t)},onPointerUp:e=>{this.outputSwitcher.onPointerUp(e);try{t.releasePointerCapture(e.pointerId)}catch(t){}}},this.outputSwitcher);else if(void 0!==window.TouchEvent){const e=new Ne(t);f(e,new Xe,this.outputSwitcher),this.input=e}else{const e=new Pe(t);f(e,new Se,this.outputSwitcher),this.input=e}}activate(){this.input.activate(),this.activatePenOnly()}deactivate(){this.deactivatePenOnly(),this.input.deactivate()}activatePenOnly(){this.pointerOverOut.activate()}deactivatePenOnly(){this.pointerOverOut.deactivate()}setErasing(){this.outputSwitcher.normalOutput=this.eraser}setInking(){this.outputSwitcher.normalOutput=this.collector}getHapticsExtractor(){return this.continuousHaptics.hapticsExtractor}}const di={alpha:!0,desynchronized:!1};function pi(t,e,i,s,n){const o=function(t,e){const i=t.getContext("2d",e);if(null===i)throw new Error("Could not get 2D context from canvas.");return i}(t,n);return function(t,e,i,s,n){(function(t,e,i,s){t.style.width=`${i}px`,t.style.height=`${s}px`,t.width=i*e,t.height=s*e})(t,e,s,n),i.setTransform(1,0,0,1,0,0),i.scale(e,e)}(t,e,o,i,s),o}function gi(t,e,i,s){return pi(t,e,i,s,di)}class mi{constructor(t){this.context=t}beginPath(){this.context.beginPath()}arc(t,e,i,s,n,o){this.context.arc(t,e,i,s,n,o)}circularArc(t,e,i,s,n,o,r,h,a){let u=Math.atan2(e-s,t-i),c=Math.atan2(r-s,o-i);u=u<0?2*Math.PI+u:u,c=c<0?2*Math.PI+c:c,this.arc(i,s,n,u,c,a)}lineTo(t,e){this.context.lineTo(t,e)}moveTo(t,e){this.context.moveTo(t,e)}closePath(){this.context.closePath()}}class fi{constructor(t,e,i=new $){this.renderMode=0,this.context=t,this.canvasPathBuilder=new mi(t),this.effectResolver=e,this.colorResolver=i}setDrawingAttributes(t){this.attributes=t}beginStroke(t){this.pathBuilder=this.makeNewPathBuilder(),this.pathBuilder.beginStroke(t),this.beginPoint=t}addPoint(t){this.pathBuilder.addPoint(t)}endStroke(t){this.pathBuilder.endStroke(t),this.context.save(),function(t,e,i,s,n){t.lineWidth=e.height;const o=function(t,e,i,s,n){if(1===e.effect.type){const s=e.effect,o=i.toCanvasImageSource(s);if(void 0!==o){const i=t.createPattern(o,"repeat");if(null!==i){const o=.5;return t.scale(o,o),t.lineWidth=e.width/o,t.translate(n.x-s.offsetX,n.y-s.offsetY),i}}}return s.toCSSColor(e.color,e)}(t,e,i,s,n);switch(t.strokeStyle=o,t.fillStyle=o,e.tip){case"ellipse":t.lineCap="round",t.lineJoin="round";break;case"rectangle":t.lineCap="butt",t.lineJoin="miter";break;default:U(e.tip)}switch(e.rasterOperation){case"copy":t.globalCompositeOperation="source-over";break;case"mask":t.globalCompositeOperation="darken";break;case"clear":t.globalCompositeOperation="destination-out";break;default:U(e.rasterOperation)}}(this.context,this.attributes,this.effectResolver,this.colorResolver,this.beginPoint),2===this.renderMode?this.context.stroke():this.context.fill(),this.context.restore()}makeNewPathBuilder(){switch(this.renderMode){case 0:return"ellipse"===this.attributes.tip?new Q(this.canvasPathBuilder,this.attributes):new ot(this.canvasPathBuilder,this.attributes);case 1:return"ellipse"===this.attributes.tip?new V(this.canvasPathBuilder,this.attributes):new st(this.canvasPathBuilder,this.attributes);case 2:return new tt(this.canvasPathBuilder);default:U(this.renderMode)}}}class yi{constructor(t,e){this.isLoopActive=!1,this.animationCallback=()=>{this.delegate(),this.isLoopActive&&this.window.requestAnimationFrame(this.animationCallback)},this.delegate=t,this.window=null!=e?e:window}onStrokeBegin(){this.isLoopActive=!0,this.window.requestAnimationFrame(this.animationCallback)}onStrokeEnd(){this.isLoopActive=!1}}class vi{constructor(t,e,i,s){this.clear=()=>{var t;(t=this.wetContext).save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore(),null!==this.wetCanvas.parentElement&&(ie.info("Wet canvas removed"),this.parent.removeChild(this.wetCanvas))},this.render=()=>{null===this.wetCanvas.parentElement&&(ie.info("Wet canvas added"),this.parent.appendChild(this.wetCanvas)),this.store.collectChanges(this.transformer)},this.wetCanvas=t,this.parent=e,this.targetElement=i,this.store=s,this.wetContext=gi(t,window.devicePixelRatio,i.clientWidth,i.clientHeight),this.wetRenderer=new fi(this.wetContext,new S),this.renderLoop=new yi(this.render),this.transformer=new C,this.transformer.modifier=t=>new R(t).setWidth(t.width*this.store.zoom).setHeight(t.height*this.store.zoom).build(),m(this.transformer,this.wetRenderer),this.store.strokeBeginEndListener=this.renderLoop,this.store.strokesProcessedListener=this.clear}updateCanvasContext(){this.wetContext=gi(this.wetCanvas,window.devicePixelRatio,this.targetElement.clientWidth,this.targetElement.clientHeight)}}function wi(){}class ki{constructor(){this.baseId=0}generate(){return this.baseId+=1}setBaseId(t){this.baseId=t}}class xi{constructor(t){this.idGenerator=new ki,this.currentStroke=new kt,this.isLineMode=!1,this.inputStrokes=[],this.newPointsIndex=0,this.noop={add:wi},this.output=this.noop,this.beginEndSink=t}setDrawingAttributes(t){this.currentStroke.drawingAttributes=t}beginStroke(t){this.newPointsIndex=0,this.currentStroke.id=this.idGenerator.generate(),this.beginEndSink.onStrokeBegin(),this.output=this.currentStroke,this.output.add(this.isLineMode?this.getConstantPressurePoint(t):t)}addPoint(t){this.isLineMode&&1===this.currentStroke.points.length?this.output.add(this.getConstantPressurePoint(t)):this.isLineMode&&this.currentStroke.points.length>1?this.currentStroke.points[this.currentStroke.points.length-1]=this.getConstantPressurePoint(t):this.output.add(t)}endStroke(t){this.output!==this.noop&&(this.isLineMode&&this.currentStroke.points.length>1?this.currentStroke.points[this.currentStroke.points.length-1]=this.getConstantPressurePoint(t):this.output.add(t),this.inputStrokes.push([this.currentStroke,this.newPointsIndex]),this.cancel())}makeCurrentStrokeStraight(){const t=this.currentStroke.points.length;t>=2&&(this.linePressure=this.getAveragePressureAcrossStroke(this.currentStroke),0===this.linePressure&&(this.linePressure=Jt),this.currentStroke.points.splice(1,t-2),this.currentStroke.points[0]=this.getConstantPressurePoint(this.currentStroke.points[0]),this.currentStroke.points[1]=this.getConstantPressurePoint(this.currentStroke.points[1]))}cancel(){this.output!==this.noop&&(this.output=this.noop,this.linePressure=void 0,this.currentStroke=new kt,this.beginEndSink.onStrokeEnd())}streamCollectedStrokes(t){this.inputStrokes.forEach((e=>{t.add(e[0]),e[1]=e[0].points.length-1}))}streamCollectedStrokesNewPoints(t){this.inputStrokes.forEach((e=>{e[1]=Pt(e[0],t,e[1])}))}resetCollectedStrokes(){this.inputStrokes=[]}streamCurrentStroke(t){this.newPointsIndex=Pt(this.currentStroke,t,0)}streamCurrentStrokeNewPoints(t){this.newPointsIndex=Pt(this.currentStroke,t,this.newPointsIndex)}getAveragePressureAcrossStroke(t){let e=0;for(let i=0;i<t.points.length;i+=1)e+=t.points[i].pressure;return 0===e||0===t.points.length?0:e/t.points.length}getConstantPressurePoint(t){return void 0===this.linePressure&&(this.linePressure=0===t.pressure?Jt:t.pressure),{x:t.x,y:t.y,pressure:this.linePressure,tiltX:t.tiltX,tiltY:t.tiltY,timestamp:t.timestamp}}}function Pi(t,e){const i=Math.min(t.right,e.right)-Math.max(t.left,e.left);if(i<=0)return 0;const s=Math.min(t.bottom,e.bottom)-Math.max(t.top,e.top);return s<=0?0:i*s/(Lt(e)*Dt(e))}function bi(t,e,i){return{row:t.row+e,col:t.col+i}}function Si(t,e,i){if(e.topLeft.row===e.bottomRight.row&&e.topLeft.col===e.bottomRight.col)return e.topLeft;if(e.topLeft.row===e.bottomRight.row){const s=i.getCellBounds(e.topLeft),n=i.getCellBounds(bi(e.topLeft,0,1));if(null===s||null===n)return;const o=Pi(t,s),r=Pi(t,n);return o>.8||o>r?e.topLeft:bi(e.topLeft,0,1)}if(e.topLeft.col===e.bottomRight.col){const s=i.getCellBounds(e.topLeft),n=i.getCellBounds(bi(e.topLeft,1,0));if(null===s||null===n)return;const o=Pi(t,s),r=Pi(t,n);return o>.8||o>r?e.topLeft:bi(e.topLeft,1,0)}const s=[];s.push(bi(e.topLeft,0,0)),s.push(bi(e.topLeft,0,1)),s.push(bi(e.topLeft,1,0)),s.push(bi(e.topLeft,1,1));let n=0,o=s[0];return s.forEach((e=>{const s=i.getCellBounds(e);if(null===s)return void(o=void 0);const r=Pi(t,s);if(r>.8)return n=r,void(o=e);r>n&&(n=r,o=e)})),o}function Ti(t,e){return t.col===e.col&&t.row===e.row}const Mi=new Map,Ei=100;function Ii(t){Mi.clear(),t.forEach((t=>{Mi.set(`${t.row},${t.col}`,t)}))}function Ai(t,e){t>0&&(t<Mi.size?ie.info(`InkAnalysisKeepRate:Partial ${e}`):ie.info(`InkAnalysisKeepRate:Full ${e}`),Mi.clear())}class Ri{constructor(t,e){this.status=t,this.message=e}}class Ci{constructor(t,e,i){this.points=[],this.id=t,this.kind=e,this.language=i}add(t){this.points.push(t.x),this.points.push(t.y)}toJson(){return{id:this.id,kind:this.kind,points:this.points.join(","),language:this.language}}}class Oi{constructor(t,e,i){this.strokes=[],this.language=t,this.version=e,this.unit=i}toJson(){const t={language:this.language,version:this.version,unit:this.unit,unitMultiple:this.unitMultiple,strokes:this.strokes.map((t=>t.toJson())),analysisHint:{wordList:this.wordList,isCompleteWordList:this.isCompleteWordList,inputScope:this.inputScope,handwritingRecognizerMinVersion:this.handwritingRecognizerMinVersion}};return void 0===this.wordList&&void 0===this.isCompleteWordList&&void 0===this.inputScope&&void 0===this.handwritingRecognizerMinVersion&&(t.analysisHint=void 0),JSON.stringify(t)}}class Li{constructor(t,e,i="en-US",s=1,n="mm"){this.url=t,this.subscriptionKey=e,this.strokes=new Oi(i,s,n)}setStrokes(t,e,i,s){this.strokes.strokes=[];let n=0;t.stream({add:t=>{const o=new Ci(n,e,i);t.streamPoints(o),this.strokes.strokes.push(o),void 0!==s&&s.set(n,t.id),n+=1}})}analyze(t,e,i,s){const n=new XMLHttpRequest;n.onerror=()=>{i(new Ri(n.status,n.responseText))},n.onload=()=>{200===n.status?e(t(n.responseText)):i(new Ri(n.status,n.responseText))};let o=this.url;void 0!==s&&(o+=`&RequestCorrelationId=${s}`),n.open("PUT",o,!0),n.setRequestHeader("Ocp-Apim-Subscription-Key",this.subscriptionKey),n.setRequestHeader("Content-Type","application/json"),n.send(this.strokes.toJson())}}function Di(t){return"none"===t?[]:t.split(",").map((t=>parseInt(t,10)))}function Ui(t){return"none"===t?[]:t.split(",").map(parseFloat)}class Hi extends class{constructor(t){this.category=t.category,this.class=t.class,this.id=t.id,this.strokeIds=Di(t.strokeIds),this.children=Di(t.children),this.parent=t.parent;const[e,i,s,n]=Ui(t.boundingRectangle);this.boundingRectangle={left:e,top:i,width:s,height:n}}}{constructor(t){super(t),this.rotatedBoundingRectangle=function(t){const e=Ui(t),i=[];for(let t=0;t+1<e.length;t+=2)i.push({x:e[t],y:e[t+1]});return i}(t.rotatedBoundingRectangle)}}class Ni extends Hi{constructor(t){super(t),this.alternates=t.alternates,this.recognizedText=t.recognizedText}}class _i extends Hi{constructor(t){super(t),this.alternates=t.alternates,this.recognizedText=t.recognizedText}}class Fi extends Hi{constructor(t){super(t),this.alternates=t.alternates,this.recognizedText=t.recognizedText}}function Xi(t){const e=JSON.parse(t),i={language:e.language,version:e.version,unit:e.unit,unitMultiple:e.unitMultiple,regions:[],paragraphs:[],listItems:[],lines:[],words:[],bullets:[]};return function(t,e){t.recognitionUnits.forEach((t=>{switch(t.category){case"writingRegion":e.regions.push(new Hi(t));break;case"paragraph":e.paragraphs.push(new Hi(t));break;case"listItem":e.listItems.push(new Hi(t));break;case"line":e.lines.push(new _i(t));break;case"inkWord":e.words.push(new Fi(t));break;case"inkBullet":e.bullets.push(new Ni(t))}}))}(e,i),i}var $i,Wi=new Uint8Array(16);function Yi(){if(!$i&&!($i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $i(Wi)}const Bi=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,Vi=function(t){return"string"==typeof t&&Bi.test(t)};for(var zi=[],ji=0;ji<256;++ji)zi.push((ji+256).toString(16).substr(1));const qi=function(t,e,i){var s=(t=t||{}).random||(t.rng||Yi)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,e){i=i||0;for(var n=0;n<16;++n)e[i+n]=s[n];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(zi[t[e+0]]+zi[t[e+1]]+zi[t[e+2]]+zi[t[e+3]]+"-"+zi[t[e+4]]+zi[t[e+5]]+"-"+zi[t[e+6]]+zi[t[e+7]]+"-"+zi[t[e+8]]+zi[t[e+9]]+"-"+zi[t[e+10]]+zi[t[e+11]]+zi[t[e+12]]+zi[t[e+13]]+zi[t[e+14]]+zi[t[e+15]]).toLowerCase();if(!Vi(i))throw TypeError("Stringified UUID is invalid");return i}(s)};class Ji{constructor(t){this.serviceInfo=t}analyze(t,e,i,s,n){if(0===this.serviceInfo.analysisUrl.length||0===this.serviceInfo.analysisKey.length)return ie.error("InkAnalysisFailed: configuration missing"),void n(0);const o=new Li(this.serviceInfo.analysisUrl,this.serviceInfo.analysisKey,i,1,"mm");o.setStrokes(t,"inkWriting"),6!==e&&(o.strokes.inputScope=function(t){switch(t){case 0:return"number";case 1:return"currency";case 2:return"date";case 3:return"time";case 4:return"text";case 5:return"spreadsheet";case 6:return"default";default:return U(t)}}(e)),o.strokes.handwritingRecognizerMinVersion=2;const r=qi(),h=5!==e;ie.info(`InkAnalysisStarted: id:${r}, strokes:${o.strokes.strokes.length}, hasScope:${h}, lang:${i}`),o.analyze(Xi,(t=>{const e=new Map;t.words.forEach((t=>{e.set(t.id,t)}));const i=[];t.lines.forEach((t=>{const s=e.get(t.children[0]);void 0!==s&&0!==s.recognizedText.length&&i.push({text:t.recognizedText,bound:{left:s.boundingRectangle.left,right:s.boundingRectangle.left+s.boundingRectangle.width,top:s.boundingRectangle.top,bottom:s.boundingRectangle.top+s.boundingRectangle.height}})})),0===i.length?(ie.error(`InkAnalysisFailed: id:${r}, code:200_Unrecognized`),n(2)):(i.sort(((t,e)=>t.bound.top-e.bound.top)),ie.info(`InkAnalysisSucceeded: id:${r}`),s(i))}),(t=>{if(400===t.status&&function(t){try{return"Language"===JSON.parse(t).target}catch(t){ie.error("Failed to parse service error")}return!1}(t.message))return ie.error(`InkAnalysisFailed: id:${r}, code:400_UnsupportedLanguageError`),void n(1);ie.error(`InkAnalysisFailed: id:${r}, code:${t.status}`),n(0)}),r)}}function Ki(t,e,i){const s=t.length;if(0===s)return[];const n=[],o=e.x,r=e.y,h=Math.sin(i),a=Math.cos(i);let u=t[0].x-o,c=t[0].y-r,l=o+u*a+c*h,d=r-u*h+c*a;n.push({x:l,y:d});for(let e=1;e<s;e+=1)u=t[e].x-o,c=t[e].y-r,l=o+u*a+c*h,d=r-u*h+c*a,n.push({x:l,y:d});return n}function Gi(t,e,i){const s=Lt(e),n=Dt(e);let o=0,r=0,h={x:0,y:0},a={x:0,y:0},u={x:0,y:0},c={x:0,y:0};const l={x:e.left,y:e.top+n*i},d={x:e.right,y:e.top+n*i},p={x:e.left+s*i,y:e.top},g={x:e.left+s*i,y:e.bottom};for(let e=0;e<t.length-2&&(Bt(l,d,t[e],t[e+1])&&(o+=1,1===o&&(h=t[e]),a=t[e]),Bt(p,g,t[e],t[e+1])&&(r+=1,1===r&&(u=t[e]),c=t[e]),!(o>12||r>12));e+=1);return o>=6&&o<=12||r>=6&&r<=12||(o>=4&&o<6?Math.abs(h.x-a.x)/s<=.7:r>=4&&r<6&&Math.abs(u.y-c.y)/n<=.7)}function Zi(t,e){return t.x*e.y-t.y*e.x}function Qi(t,e,i=1e-4){return Math.abs(t-e)<i}function ts(t){return!(t.t<-t.fuzz||t.t>t.fuzz+1||(t.t<0&&(t.t=0),t.t>1&&(t.t=1),0))}function es(t,e,i,s,n){let o=0,r=0,h=!1;const a=w(t,i),u=-Zi(s,e);if(Qi(u,0))return{hasIntersection:h,r:o,s:r};const c={fuzz:n,t:-Zi(a,e)/u};if(!ts(c))return{hasIntersection:h,r:o,s:r};const l={fuzz:n,t:Zi(s,a)/u};return ts(l)?(h=!0,r=c.t,o=l.t,{hasIntersection:h,r:o,s:r}):{hasIntersection:h,r:o,s:r}}const is=1e-4;function ss(t,e){return Qi(t.x,e.x,is)&&Qi(t.y,e.y,is)}function ns(t,e,i,s){const n=t.length;if(e>=i||i>n-1||n<2)return!1;let o=0;const r=Math.floor(e),h=Math.ceil(i);for(let n=r;n<h;n+=1)if(!ss(t[n],t[n+1])&&(o+=Math.sqrt(x(t[n+1],t[n])),n===r&&e!==Math.floor(e)?o*=1-(e-n):n===h-1&&i!==Math.ceil(i)&&(o*=i-n),(a=o)>(u=s)||Qi(a,u)))return!0;var a,u;return!1}function os(t,e){const i=t.length;if(i<4)return!1;let s=0,n=0,o=t[0];for(s=1;s<i-2;s+=1){if(ss(t[s],t[s-1]))continue;const r=t[s],h=w(r,o);for(n=s+1;n<i&&ss(t[n],t[n-1]);)n+=1;if(n<i){let a=t[n];for(n+=1;n<i;n+=1){if(ss(t[n],t[n-1]))continue;const i=t[n],r=w(i,a),{hasIntersection:u,r:c,s:l}=es(o,h,a,r,.001);if(u&&ns(t,s+c-1,n+l-1,e))return!0;a=i}o=r}}return!1}class rs{constructor(t){this.centroid={x:0,y:0},this.majorAxis={x:0,y:0},this.majorAxisAngleInRadian=0,this.eigenRatio=0;const e=function(t){const e={numPoints:0,sumX:0,sumY:0,sumXX:0,sumYY:0,sumXY:0,direction:{x:0,y:0},centroid:{x:0,y:0}};return t.length<=0||(e.numPoints=t.length,t.forEach((t=>{const i=t.x,s=t.y;e.sumX+=i,e.sumY+=s,e.sumXX+=i*i,e.sumYY+=s*s,e.sumXY+=i*s})),e.direction=w(t[t.length-1],t[0]),e.centroid={x:e.sumX/e.numPoints,y:e.sumY/e.numPoints}),e}(t);this.constructFrom(e)}getCentroid(){return this.centroid}getMajorAxisAngleInRadian(){return this.majorAxisAngleInRadian}getEigenRatio(){return this.eigenRatio}constructFrom(t){const e=t.numPoints;if(0===e)return;const i=t.sumXX-t.sumX*t.sumX/e,s=t.sumXY-t.sumX*t.sumY/e,n=t.sumYY-t.sumY*t.sumY/e;let o=i+n;const r=i*n-s*s,h=Math.sqrt(o*o-4*r),a=(o-h)/2,u=(o+h)/2;this.eigenRatio=Number.EPSILON<u?a/u:0,o=u-i;const c=Math.sqrt(s*s+o*o);Number.EPSILON>c?(this.majorAxis.x=1,this.majorAxis.y=0):(this.majorAxis.x=s/c,this.majorAxis.y=o/c);const l=t.direction;(l.x>0&&this.majorAxis.x<0||l.x<0&&this.majorAxis.x>0)&&(this.majorAxis.x=-this.majorAxis.x),(l.y>0&&this.majorAxis.y<0||l.y<0&&this.majorAxis.y>0)&&(this.majorAxis.y=-this.majorAxis.y),this.centroid=t.centroid,this.majorAxisAngleInRadian=Math.atan2(this.majorAxis.y,this.majorAxis.x)}}var hs;function as(t,e){const i=[];if(t.streamPoints({add:t=>{i.push({x:t.x,y:t.y})}}),Lt(s=e.bounds)<10&&Dt(s)<10)return hs.Dot;var s;const n=new rs(i),o=n.getCentroid(),r=n.getMajorAxisAngleInRadian(),h=Ki(i,o,r),a=function(t){if(t.length<=0)return{left:0,top:0,right:0,bottom:0};let e=Number.MAX_VALUE,i=-Number.MAX_VALUE,s=Number.MAX_VALUE,n=-Number.MAX_VALUE;return t.forEach((t=>{t.x<e?e=t.x:t.x>i&&(i=t.x),t.y<s?s=t.y:t.y>n&&(n=t.y)})),{left:e,top:s,right:i,bottom:n}}(h);return function(t,e,i){if(t.length<4)return!1;const s=Lt(i),n=Dt(i);return 0!==s&&0!==n&&!(s/n<.1)&&(Gi(t,e,.5)||Gi(t,e,1/3)||Gi(t,e,2/3))}(h,a,e.bounds)?!os(h,t.drawingAttributes.width)&&us(e)?hs.Squiggle:hs.None:function(t,e,i){return function(t,e){const i=t.length;return!(i<2)&&(2===i||Lt(e)/Dt(e)>6)}(t,e)&&function(t){return t>=-Math.PI/6&&t<=Math.PI/6||t>=5*Math.PI/6&&t<=Math.PI||t<=-5*Math.PI/6&&t>=-Math.PI}(i)}(h,a,r)?!os(h,t.drawingAttributes.width)&&us(e)?hs.Line:hs.None:function(t,e){const i=t.length;if(i<2)return!1;const s=x(t[i-1],t[0]),n=Lt(e),o=Dt(e),r=n*n+o*o;return r>1e-9&&s/r<=.3}(h,a)&&function(t){if(!Ti(t.adjustedRange.topLeft,t.adjustedRange.bottomRight))return!0;const e=t.bounds,i=Lt(e)*Dt(e)/(Lt(t.outerBounds)*Dt(t.outerBounds));return Lt(e)/Dt(e)>=1.3||i>.5}(e)?function(t,e,i){const s=Lt(i)*Dt(i);if(s<=1e-9)return!1;const n=function(t){const e=t.length;if(e<3)return 0;let i,s=0,n=t[0];for(let o=1;o<e;o+=1)i=t[o],s+=(n.y+i.y)*(i.x-n.x)/2,n=i;return i=t[0],s+=(n.y+i.y)*(i.x-n.x)/2,s<0&&(s=-s),s}(t),o=n/s,r=function(t){const e=t.length;if(e<2)return 0;let i,s=0,n=t[0],o=0,r=0;for(let h=1;h<e;h+=1)i=t[h],o=i.x-n.x,r=i.y-n.y,s+=Math.sqrt(o*o+r*r),n=i;return i=t[0],o=i.x-n.x,r=i.y-n.y,s+=Math.sqrt(o*o+r*r),s}(t);let h=0;n>1e-9&&(h=r*r/(4*n*3.14159265359));const{center:a,angle:u,axisLong:c,axisShort:l}=function(t){const e=t.length;let i=0,s={x:0,y:0},n=0,o=0;if(0===e)return{center:s,angle:i,axisLong:n,axisShort:o};let r=0,h=0;const a=t[0].x,u=t[0].y;let c=0,l=0,d=0,p=0,g=0;t.forEach((t=>{r=t.x-a,h=t.y-u,c+=r,l+=h,d+=r*r,p+=h*h,g+=r*h}));const m=c/e,f=l/e,y=d/e-m*m,v=p/e-f*f,w=g/e-m*f,k=(y-v)/2,x=w;0===k&&0===x||(i=Math.atan(x/k)/2),s={x:m+a,y:f+u};const P=(y-v)*(y-v)+w*w*4,b=Math.sqrt(P);return n=2*Math.sqrt(y+v+b),o=2*Math.sqrt(y+v-b),{center:s,angle:i,axisLong:n,axisShort:o}}(e),d=function(t,e,i,s,n){const o=e.x,r=e.y,h=Ki(t,e,i),a=s/n;let u=0;return h.forEach((t=>{const e=(t.x-o)/a,i=t.y-r;let s=Math.sqrt(e*e+i*i)/n;s=s<1?1/s:s,s=Math.abs(s-1),u<s&&(u=s)})),u}(e,a,u,c/2,l/2);return function(t,e,i){return t>.55&&t<1&&e>1&&e<4&&i<2}(o,h,d)}(h,i,a)?hs.Ellipse:hs.Enclosure:hs.None}function us(t){if(!Ti(t.adjustedRange.topLeft,t.adjustedRange.bottomRight))return!0;const e=t.bounds,i=Lt(e)/Lt(t.outerBounds);return Lt(e)/Dt(e)>=1.3&&i>.5}!function(t){t.None="None",t.Dot="Dot",t.Line="Line",t.Squiggle="Squiggle",t.Ellipse="Ellipse",t.Enclosure="Enclosure"}(hs||(hs={}));class cs{constructor(t,e){this.zoom=1,this.isStandardZoomCss=!1,this.mode=0,this.strokes=new wt,this.taskTimeoutId=-1,this.task=()=>{},this.host=t,this.analyzer=new Ji(this.host.getServiceInfo()),this.playHapticFeedback=e,this.collector=new xi({onStrokeBegin:()=>{this.strokeBeginEndListener.onStrokeBegin(),this.resetPendingTask()},onStrokeEnd:()=>{this.strokeBeginEndListener.onStrokeEnd()}}),this.strokesSink={add:t=>{this.strokes.add(t),this.triggerProcessing()}}}clear(){this.strokes=new wt}getDryStore(){return this.host.getDryStore()}collectChanges(t){this.collector.streamCurrentStrokeNewPoints(t),this.collector.streamCollectedStrokesNewPoints(t),this.collector.streamCollectedStrokes(this.strokesSink),this.collector.resetCollectedStrokes()}setMode(t){this.mode=t,this.flush()}getMode(){return this.mode}flush(){-1!==this.taskTimeoutId&&(this.resetPendingTask(),this.task()),this.resetStrokes()}onPointerDown(t){this.host.onPointerDown(t)}triggerProcessing(){if(this.strokes.strokes.length<=0)return;const t=this.host.getGrid();let e=qt(this.strokes);if(2===this.mode&&(e=Ht(e,this.strokes.strokes[0].drawingAttributes.width/2*this.zoom,this.strokes.strokes[0].drawingAttributes.height/2*this.zoom)),(2===this.mode||1===this.mode)&&!t.isDataEntryAllowed(e))return ie.info("Entry blocked"),void this.resetStrokes();const i=function(t,e){const i=t.getRange(e);if(null===i)return;const s=t.getCellBounds(i.topLeft),n=t.getCellBounds(i.bottomRight);if(null===s||null===n)return;const o=function(t,e){const i={top:t.top,left:t.left,bottom:t.bottom,right:t.right};return Nt(i,e),i}(s,n),r=(h=s,a=n,{top:Math.min(h.bottom,a.bottom),bottom:Math.max(h.top,a.top),left:Math.min(h.right,a.right),right:Math.max(h.left,a.left)});var h,a;const u={sheetName:i.sheetName,topLeft:{row:i.topLeft.row,col:i.topLeft.col},bottomRight:{row:i.bottomRight.row,col:i.bottomRight.col}};return u.bottomRight.col>u.topLeft.col&&((r.left-e.left)/(r.left-o.left)<.3&&(u.topLeft.col=u.topLeft.col+1),u.bottomRight.col>u.topLeft.col&&(e.right-r.right)/(o.right-r.right)<.3&&(u.bottomRight.col=u.bottomRight.col-1)),u.bottomRight.row>u.topLeft.row&&((r.top-e.top)/(r.top-o.top)<.4&&(u.topLeft.row=u.topLeft.row+1),u.bottomRight.row>u.topLeft.row&&(e.bottom-r.bottom)/(o.bottom-r.bottom)<.4&&(u.bottomRight.row=u.bottomRight.row-1)),{range:i,adjustedRange:u,bounds:e,innerBounds:r,outerBounds:o}}(t,e);if(void 0===i)return ie.error("Failed to calculate coverage"),void this.resetStrokes();if(1===this.mode&&1===this.strokes.strokes.length){const t=as(this.strokes.strokes[0],i);switch(t){case hs.Squiggle:case hs.Line:return void this.triggerDelete(i,t);case hs.Dot:case hs.Ellipse:case hs.Enclosure:return void this.triggerSelect(i,t)}}switch(this.mode){case 0:this.triggerInk(i);break;case 2:this.triggerHighlight(i);break;case 1:this.triggerDataEntry(i);break;default:U(this.mode)}}setTask(t,e){-1!==this.taskTimeoutId&&this.resetPendingTask(),this.task=()=>{t(),this.taskTimeoutId=-1},this.taskTimeoutId=window.setTimeout(this.task,e)}triggerInk(t){this.setTask((()=>{const e=function(t){const e=[];return t.stream({add:t=>{e.push(function(t){const e={id:t.id,drawingAttributes:t.drawingAttributes,x:[],y:[],pressure:[],tiltX:[],tiltY:[],timestamp:[]};return t.streamChannels({addPoint:t=>{e.x.push(t.x),e.y.push(t.y)},addPressure:t=>{e.pressure.push(t)},addTilt:t=>{e.tiltX.push(t.tiltX),e.tiltY.push(t.tiltY)},addTimestamp:t=>{e.timestamp.push(t)}}),JSON.stringify(e)}(t))}}),`[${e.join(",")}]`}(this.strokes);this.host.getDryStore().add(t.range,t.outerBounds,t.bounds,e),this.logAction("StrokeInsertion",this.strokes.strokes.length),this.resetStrokes()}),1500)}triggerHighlight(t){const e=this.host.getGrid(),i=e.getHighlight(t.adjustedRange),s=this.strokes.strokes[0].drawingAttributes.color;if(null===i||i.r!==s.r||i.g!==s.g||i.b!==s.b)return this.logAction("Highlight"),this.playHapticFeedback(ae.WAVEFORM_SUCCESS,.75),e.highlight(t.adjustedRange,s),void this.resetStrokes();this.logAction("UnHighlight"),e.unHighlight(t.adjustedRange),this.resetStrokes()}triggerSelect(t,e){this.playHapticFeedback(ae.WAVEFORM_SUCCESS,.75),this.setTask((()=>{const i=this.host.getGrid();this.logAction(hs[e]),i.select(t.adjustedRange),this.resetStrokes()}),500)}triggerDelete(t,e){this.playHapticFeedback(ae.WAVEFORM_SUCCESS,.75),this.setTask((()=>{const i=this.host.getGrid();this.logAction(hs[e]),function(t,e){let i=0,s=0;0!==Mi.size&&(Mi.forEach((n=>{s++,s===Ei&&Ai(i,e.concat(" ","with CellLoopMaximum reached")),s>=Ei||n.row>=t.topLeft.row&&n.row<=t.bottomRight.row&&n.col>=t.topLeft.col&&n.col<=t.bottomRight.col&&i++})),s<Ei&&Ai(i,e))}(t.adjustedRange,"Delete"),i.erase(t.adjustedRange),this.resetStrokes()}),500)}triggerDataEntry(t){this.setTask((()=>{const e=this.host.getGrid(),i=e.getInputScope(t.range),s=this.host.getLanguage(),n=this.strokes;this.strokes=new wt,this.analyzer.analyze(n,i,s,(t=>{this.logAction("EnterData",n.strokes.length),this.playHapticFeedback(ae.WAVEFORM_SUCCESS,.75),e.enterText(function(t,e){if(0===t.length)return[];const i=[],s=function(t,e){const i=[];for(let s=0;s<t.length;s+=1){const n=e.getRange(t[s].bound);if(null===n)return;const o=Si(t[s].bound,n,e);if(void 0===o)return;i.push(o)}return i}(t,e);if(void 0===s)return[];!function(t,e){let i=0,s=0;if(0!==Mi.size){for(const n of t)if(s++,Mi.has(`${n.row},${n.col}`)&&i++,s===Ei)return Ai(i,e.concat(" ","with CellLoopMaximum reached")),void Ii(t);Ai(i,e),Ii(t)}else Ii(t)}(s,"Overwrite"),i.push({text:t[0].text,cell:s[0]});for(let r=1;r<s.length;r+=1){const h=s[r-1],a=s[r];if(Ti(a,h)){const h=e.getCellBounds(a);if(null===h)return[];r<s.length-1&&Ti(bi(a,1,0),s[r+1])||(o=h,(n=t[r].bound).top>=o.top&&n.left>=o.left&&n.right<=o.right&&n.bottom<=o.bottom)?i[i.length-1].text=`${i[i.length-1].text} ${t[r].text}`:i.push({text:t[r].text,cell:bi(a,1,0)})}else i.push({text:t[r].text,cell:a})}var n,o;return i}(t,e)),this.strokesProcessedListener()}),(t=>{ie.error(`DisplayError: ${t}`),this.host.displayError(t),this.strokesProcessedListener()}))}),1500)}resetStrokes(){this.strokes=new wt,this.strokesProcessedListener()}resetPendingTask(){window.clearTimeout(this.taskTimeoutId),this.taskTimeoutId=-1}logAction(t,e){void 0===e?ie.info(`Action:${t}`):ie.info(`Action:${t}, Strokes:${e}`)}}class ls{constructor(t,e,i,s){this.parent=t,this.wetCanvas=function(){const t=H("canvas");return t.style.touchAction="none",t.style.pointerEvents="none",t.style.position="absolute",t.style.top="0",t.style.left="0",t}(),this.eventLayer=function(t){const e=H("div");return e.style.width=`${t.clientWidth}px`,e.style.height=`${t.clientHeight}px`,e.style.touchAction="none",e.style.pointerEvents="none",e.style.position="absolute",e.style.top="0",e.style.left="0",e}(e),t.appendChild(this.eventLayer),this.targetElement=e,this.inkMinutesMetric=new de(ne,1),this.store=new cs(s,((t,e)=>{this.pipeline.getHapticsExtractor().play((()=>ce({waveformId:t,intensity:e,vendorId:"",alternates:[]})))})),this.pipeline=new li(this.eventLayer,i,this.store,(()=>this.getDrawingHaptics())),this.renderer=new vi(this.wetCanvas,t,this.targetElement,this.store),this.attributes=new R,this.color=new dt}start(){this.pipeline.activate(),this.inkMinutesMetric.activate(this.eventLayer)}stop(){this.renderer.clear(),this.pipeline.deactivate(),this.inkMinutesMetric.deactivate()}enableTouchMouse(){re(this.eventLayer),this.pipeline.deactivatePenOnly()}disableTouchMouse(){this.pipeline.activatePenOnly(),he(this.eventLayer)}clear(){this.renderer.clear(),this.store.clear()}selectEraser(){this.pipeline.setErasing(),this.store.flush(),this.inkMinutesMetric.start(ue.Erase)}selectPen(t,e,i){const s=(n=e,Math.min(13.22835,.94488*Math.pow(2,n-1)));var n;this.attributes.setWidth(s).setHeight(s).setColor(this.color.setHexRGB(t).build()).setTip("ellipse").setRasterOperation("copy"),this.pipeline.injector.setDrawingAttributes(this.attributes.build()),this.parent.style.setProperty("opacity","1"),this.store.setMode(i?1:0),this.pipeline.setInking(),this.inkMinutesMetric.start(i?ue.ActionPen:ue.Pen)}selectHighlighter(t,e,i){const s=7.55906*e;this.attributes.setWidth(s/2).setHeight(s).setColor(this.color.setHexRGB(t).build()).setTip("rectangle").setRasterOperation("mask"),this.pipeline.injector.setDrawingAttributes(this.attributes.build()),this.parent.style.setProperty("opacity","0.5"),this.store.setMode(i?2:0),this.pipeline.setInking(),this.inkMinutesMetric.start(ue.Highlighter)}flush(){this.store.flush()}updateCanvasDimensions(){this.eventLayer.style.width=`${this.targetElement.clientWidth}px`,this.eventLayer.style.height=`${this.targetElement.clientHeight}px`,this.renderer.updateCanvasContext()}setZoom(t){this.store.zoom=t>0?t:1}setIsStandardZoomCss(t){this.store.isStandardZoomCss=t}onCanvasesCrashDetected(){ie.error("Canvas Crash")}getDrawingHaptics(){return"rectangle"===this.attributes.build().tip?ae.WAVEFORM_MARKER_CONTINUOUS:ae.WAVEFORM_INK_CONTINUOUS}}class ds{constructor(t,e=!1){this.isPipelineEnabled=!1,this.isTouchMouseEnabled=!1,this.recentPenColors=["#FFC114","#F6630D","#FF0066","#5B2D90"],this.recentHighlighterColors=["#00F900","#00FDFF","#FF40FF","#FF8517"],this.canvas=t,this.tools=function(t,e,i){return{InkSelect:{id:"InkSelect",thickness:0,color:"",recentColors:[],toolType:0,snapToText:!1},InkEraser:{id:"InkEraser",thickness:3,color:"",recentColors:[],toolType:1,snapToText:!1},InkPen1:{id:"InkPen1",thickness:3,color:"#000000",recentColors:e,toolType:2,snapToText:!1},InkPen2:{id:"InkPen2",thickness:3,color:"#E71224",recentColors:e,toolType:2,snapToText:!1},InkActionPen:{id:"InkActionPen",thickness:2,color:"#32B16B",recentColors:[],toolType:2,snapToText:!0},InkHighlighter:{id:"InkHighlighter",thickness:3,color:"#FFFC00",recentColors:i,toolType:3,snapToText:!t}}}(e,this.recentPenColors,this.recentHighlighterColors),this.isInkAnnotationEnabled=e,this.selectDefaultTool()}setDrawWithTouch(t){this.isTouchMouseEnabled!==t&&(this.isTouchMouseEnabled=t,this.isTouchMouseEnabled?(this.currentTool===this.tools.InkSelect&&this.selectDefaultTool(),this.canvas.enableTouchMouse()):this.canvas.disableTouchMouse())}setColor(t){if(void 0===this.currentTool)return;this.currentTool.color=t;const e=this.currentTool.recentColors,i=e.indexOf(t);i>-1?e.unshift(e.splice(i,1)[0]):(e.unshift(t),e.pop()),this.setTool(this.currentTool)}setThickness(t){void 0!==this.currentTool&&(this.currentTool.thickness=t,this.setTool(this.currentTool))}setSnapToText(t){void 0!==this.currentTool&&(this.currentTool.snapToText=t,this.setTool(this.currentTool))}selectSelect(){this.setTool(this.tools.InkSelect)}selectActionPen(){this.setTool(this.tools.InkActionPen)}selectHighlighter(){this.setTool(this.tools.InkHighlighter)}selectEraser(){this.setTool(this.tools.InkEraser)}selectPen1(){this.setTool(this.tools.InkPen1)}selectPen2(){this.setTool(this.tools.InkPen2)}getCurrentTool(){return this.currentTool}getTool(t){return void 0!==this.tools[t]?this.tools[t]:null}isDrawWithTouchEnabled(){return this.isTouchMouseEnabled}isEnabled(){return this.isPipelineEnabled}setEnabled(t){this.isPipelineEnabled!==t&&(this.isPipelineEnabled=t,this.isPipelineEnabled?this.canvas.start():(this.isTouchMouseEnabled=!1,this.canvas.disableTouchMouse(),this.canvas.stop()))}setTool(t){switch(this.canvas.flush(),this.currentTool=t,t.toolType){case 2:this.setEnabled(!0),this.canvas.selectPen(t.color,t.thickness,t.snapToText);break;case 3:this.setEnabled(!0),this.canvas.selectHighlighter(t.color,t.thickness,t.snapToText);break;case 1:this.setEnabled(!0),this.canvas.selectEraser();break;case 0:this.setEnabled(!1)}}selectDefaultTool(){this.isInkAnnotationEnabled?this.selectPen1():this.selectHighlighter()}}const ps=new class{create(t,e,i,s,n,o,r){se(n),void 0!==o&&oe(o);const h=new ls(t,e,i,s);return new ds(h,r)}};InkHost=e})();
//# sourceMappingURL=InkHost.min.js.map